
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  
    <title>QuickJS 引擎一年见闻录 | ewind the doodler</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="doodlewind">
    

    
    <meta name="description" content="时间过得真快，转眼间 QuickJS 引擎已经发布一年了。一年来，围绕着它都发生了些什么呢？这篇文章会以一名普通社区用户的视角，聊些值得一提的见闻。内容主要包括这些：  特性更新简介 社区生态与应用案例 若干常见问题 对比总结  注意下面主要只是个人的评述，而我的水平显然是远不配和 Fabrice 相提并论的。大家如果有兴趣和时间，还是推荐直接啃第一手资料噢。 特性更新简介自 2019 年 7 月">
<meta name="keywords" content="Web">
<meta property="og:type" content="article">
<meta property="og:title" content="QuickJS 引擎一年见闻录">
<meta property="og:url" content="https://ewind.us/2020/quickjs-one-year-brief/index.html">
<meta property="og:site_name" content="ewind the doodler">
<meta property="og:description" content="时间过得真快，转眼间 QuickJS 引擎已经发布一年了。一年来，围绕着它都发生了些什么呢？这篇文章会以一名普通社区用户的视角，聊些值得一提的见闻。内容主要包括这些：  特性更新简介 社区生态与应用案例 若干常见问题 对比总结  注意下面主要只是个人的评述，而我的水平显然是远不配和 Fabrice 相提并论的。大家如果有兴趣和时间，还是推荐直接啃第一手资料噢。 特性更新简介自 2019 年 7 月">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://ewind.us/images/quickjs/test262.png">
<meta property="og:updated_time" content="2020-07-20T01:31:15.439Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="QuickJS 引擎一年见闻录">
<meta name="twitter:description" content="时间过得真快，转眼间 QuickJS 引擎已经发布一年了。一年来，围绕着它都发生了些什么呢？这篇文章会以一名普通社区用户的视角，聊些值得一提的见闻。内容主要包括这些：  特性更新简介 社区生态与应用案例 若干常见问题 对比总结  注意下面主要只是个人的评述，而我的水平显然是远不配和 Fabrice 相提并论的。大家如果有兴趣和时间，还是推荐直接啃第一手资料噢。 特性更新简介自 2019 年 7 月">
<meta name="twitter:image" content="https://ewind.us/images/quickjs/test262.png">

    
    <link rel="alternative" href="/atom.xml" title="ewind the doodler" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/logo-app.png">
    <link rel="apple-touch-icon-precomposed" href="/img/logo-app.png">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="ewind the doodler" title="ewind the doodler"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="ewind the doodler">ewind the doodler</a></h1>
				<h2 class="blog-motto">我想超越这平凡的生活，注定现在就是漂泊</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" autocomplete="off" name="q" maxlength="20" placeholder="搜索" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/quickjs-one-year-brief/" title="QuickJS 引擎一年见闻录" itemprop="url">QuickJS 引擎一年见闻录</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="doodlewind" target="_blank" itemprop="author">doodlewind</a>
		
  <p class="article-time">
    <time datetime="2020-07-18T16:00:00.000Z" itemprop="datePublished"> 发表于 2020-07-19</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#特性更新简介"><span class="toc-number">1.</span> <span class="toc-text">特性更新简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#社区生态与应用案例"><span class="toc-number">2.</span> <span class="toc-text">社区生态与应用案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常见问题"><span class="toc-number">3.</span> <span class="toc-text">常见问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#对比总结"><span class="toc-number">4.</span> <span class="toc-text">对比总结</span></a></li></ol>
		
		</div>
		
		<p>时间过得真快，转眼间 QuickJS 引擎已经发布一年了。一年来，围绕着它都发生了些什么呢？这篇文章会以一名普通社区用户的视角，聊些值得一提的见闻。内容主要包括这些：</p>
<ul>
<li>特性更新简介</li>
<li>社区生态与应用案例</li>
<li>若干常见问题</li>
<li>对比总结</li>
</ul>
<p>注意下面主要只是个人的评述，而我的水平显然是远不配和 Fabrice 相提并论的。大家如果有兴趣和时间，还是推荐直接啃第一手资料噢。</p>
<h2 id="特性更新简介"><a href="#特性更新简介" class="headerlink" title="特性更新简介"></a>特性更新简介</h2><p>自 2019 年 7 月以来，QuickJS 共发布了 14 个版本，基本以月为单位不定期地更新。除了修复邮件列表上反馈的 bug 之外，引擎也在细水长流地加入新功能，并不是个「出道即巅峰」的纯炫技作品。当然，Fabrice 这种世外高人也不是凡人随便使唤得动的，这个项目也有些「改善性需求」尚未落地，会在后面提及。</p>
<p>QuickJS 在引擎特性上的更新，主要可以分为下面这些部分：</p>
<ul>
<li>新语言特性支持</li>
<li>配套运行时的新 API</li>
<li>新 C 语言 API</li>
</ul>
<p>首先，QuickJS 相当注重对 ECMAScript 新老特性的支持，其规范支持度和兼容性，可能比很多人想象中都要高。目前它的主页介绍已经默默从「支持 ES2019」变成了「支持 ES2020」，一年来主要支持了下面这些 Stage 3 以上的新语言特性：</p>
<ul>
<li>空值合并运算符（nullish coalescing operator）。</li>
<li>可选链操作符（optional chaining）。</li>
<li>备受争议的 class private field。</li>
<li>Promise 的 allSettled 与 any 方法，以及相应的 AggregateError。</li>
<li>Object.fromEntries</li>
<li>String.prototype.replaceAll 和 String.prototype.matchAll</li>
<li>import.meta</li>
</ul>
<p>目前，QuickJS 的 <a href="https://test262.report/browse/?engines=javascriptcore%2Cspidermonkey%2Cv8%2Chermes%2Cqjs" target="_blank" rel="noopener">Test262</a> 整体用例通过率高达 96%，它在 Language Syntax 和 Standard Built-in Objects 两项里都排名第一，对历史遗留问题 Annex B 部分的支持度也高得令人发指，就标准支持度而言已经超过了 SpiderMonkey 和 JavaScriptCore，和 V8 不分上下：</p>
<p><img src="/images/quickjs/test262.png" alt></p>
<p>除此之外，最能体现 QuickJS 特色的，还是它目前独家支持的两项 Stage 1 语言特性，一个是十进制浮点数运算的 <a href="https://github.com/tc39/proposal-decimal" target="_blank" rel="noopener">proposal-decimal</a>，另一个是 <a href="https://github.com/tc39/proposal-operator-overloading" target="_blank" rel="noopener">proposal-operator-overloading</a>。鉴于这两项提案不少同学可能还没有听说过，这里简单介绍一下它们。</p>
<p>首先是 QuickJS 在 2020 年第一个版本里支持的 Decimal 提案。它想解决的是很多 JS 新手都会困惑的这个经典浮点数问题：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="number">0.1</span> + <span class="number">0.2</span> === <span class="number">0.3</span> <span class="comment">// false</span></span><br></pre></td></tr></table></figure>
<p>这显然是浮点数舍入误差导致的。为此，提案支持无舍入误差的十进制浮点数运算，并且能自定义取整方式。这对应于新的 <code>0.1m</code> 形式字面量（类似 BigInt 的 <code>10n</code>），为此也引入了新的基础类型：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> x = <span class="number">0.1</span>m</span><br><span class="line">x + <span class="number">0.2</span>m === <span class="number">0.3</span>m <span class="comment">// true</span></span><br><span class="line"><span class="keyword">typeof</span> x <span class="comment">// "bigdecimal"</span></span><br></pre></td></tr></table></figure>
<p>这个特性是通过 Fabrice 以前的作品 <a href="https://bellard.org/libbf/" target="_blank" rel="noopener">libbf</a> 浮点库实现的，它可以支持任意精度的浮点运算。同样在 2020 年 1 月的更新里，他在 QuickJS 主页放出了一段 JS，能把圆周率计算到小数点后 10 亿位。Decimal 提案在介绍部分引用了 Fabrice 的这段代码，怀疑 TC39 里有多少人看得懂它：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* compute PI with a precision of 'prec' digits */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calc_pi</span>(<span class="params">prec</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> CHUD_A = <span class="number">13591409</span>m;</span><br><span class="line">    <span class="keyword">const</span> CHUD_B = <span class="number">545140134</span>m;</span><br><span class="line">    <span class="keyword">const</span> CHUD_C = <span class="number">640320</span>m;</span><br><span class="line">    <span class="keyword">const</span> CHUD_C3 = <span class="number">10939058860032000</span>m; <span class="comment">/* C^3/24 */</span></span><br><span class="line">    <span class="keyword">const</span> CHUD_DIGITS_PER_TERM = <span class="number">14.18164746272548</span>; <span class="comment">/* log10(C/12)*3 */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* return [P, Q, G] */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">chud_bs</span>(<span class="params">a, b, need_G</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> c, P, Q, G, P1, Q1, G1, P2, Q2, G2, b1;</span><br><span class="line">        <span class="keyword">if</span> (a == (b - <span class="number">1</span>n)) &#123;</span><br><span class="line">            b1 = BigDecimal(b);</span><br><span class="line">            G = (<span class="number">2</span>m * b1 - <span class="number">1</span>m) * (<span class="number">6</span>m * b1 - <span class="number">1</span>m) * (<span class="number">6</span>m * b1 - <span class="number">5</span>m);</span><br><span class="line">            P = G * (CHUD_B * b1 + CHUD_A);</span><br><span class="line">            <span class="keyword">if</span> (b &amp; <span class="number">1</span>n)</span><br><span class="line">                P = -P;</span><br><span class="line">            G = G;</span><br><span class="line">            Q = b1 * b1 * b1 * CHUD_C3;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            c = (a + b) &gt;&gt; <span class="number">1</span>n;</span><br><span class="line">            [P1, Q1, G1] = chud_bs(a, c, <span class="literal">true</span>);</span><br><span class="line">            [P2, Q2, G2] = chud_bs(c, b, need_G);</span><br><span class="line">            P = P1 * Q2 + P2 * G1;</span><br><span class="line">            Q = Q1 * Q2;</span><br><span class="line">            <span class="keyword">if</span> (need_G)</span><br><span class="line">                G = G1 * G2;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                G = <span class="number">0</span>m;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [P, Q, G];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> n, P, Q, G;</span><br><span class="line">    <span class="comment">/* number of serie terms */</span></span><br><span class="line">    n = BigInt(<span class="built_in">Math</span>.ceil(prec / CHUD_DIGITS_PER_TERM)) + <span class="number">10</span>n;</span><br><span class="line">    [P, Q, G] = chud_bs(<span class="number">0</span>n, n, <span class="literal">false</span>);</span><br><span class="line">    Q = BigDecimal.div(Q, (P + Q * CHUD_A),</span><br><span class="line">                       &#123; <span class="attr">roundingMode</span>: <span class="string">"half-even"</span>,</span><br><span class="line">                         maximumSignificantDigits: prec &#125;);</span><br><span class="line">    G = (CHUD_C / <span class="number">12</span>m) * BigDecimal.sqrt(CHUD_C,</span><br><span class="line">                                         &#123; <span class="attr">roundingMode</span>: <span class="string">"half-even"</span>,</span><br><span class="line">                                           maximumSignificantDigits: prec &#125;);</span><br><span class="line">    <span class="keyword">return</span> Q * G;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与此相关的引擎特性还有一个自定义的 <code>&quot;use math&quot;</code> 指令。启用后，字面量 <code>1.0</code> 的类型会变成 <code>&quot;bigfloat&quot;</code>（二进制表示的任意长浮点数）。目前这部分特性还是 opt-in 的，可以通过 <code>qjs --bignum</code> 开启。</p>
<p>而 QuickJS 对 BigDecimal 的实现，也与另一个运算符重载提案有着千丝万缕的联系。需要做向量和矩阵运算的同学，应该都知道运算符重载对这类代码可读性的影响。比如在 TensorFlow.js 里的这种代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">predict</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// y = a * x ^ 3 + b * x ^ 2 + c * x + d</span></span><br><span class="line">  <span class="keyword">return</span> tf.tidy(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a.mul(x.pow(tf.scalar(<span class="number">3</span>, <span class="string">'int32'</span>)))</span><br><span class="line">      .add(b.mul(x.square()))</span><br><span class="line">      .add(c.mul(x))</span><br><span class="line">      .add(d);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就可以写成这样：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">predict</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">with</span> operators <span class="keyword">from</span> tf.equation;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// y = a * x ^ 3 + b * x ^ 2 + c * x + d</span></span><br><span class="line">  <span class="keyword">return</span> tf.tidy(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a * x ** tf.scalar(<span class="number">3</span>, <span class="string">'int32'</span>)</span><br><span class="line">         + b * x.square()</span><br><span class="line">         + c * x</span><br><span class="line">         + d;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>QuickJS 已经支持了这项 Stage 1 提案，中途还帮助修复了提案伪代码算法中的 <a href="https://github.com/tc39/proposal-operator-overloading/pull/22" target="_blank" rel="noopener">bug</a>。在引擎源码里用作演示而配套的 <code>qjscalc</code> 计算器中，就重度应用了运算符重载，这样由嵌套数组构成的矩阵可以直接加减乘除：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 3x3 矩阵</span></span><br><span class="line"><span class="keyword">const</span> a = [[<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]]</span><br><span class="line"><span class="keyword">const</span> b = [[<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]]</span><br><span class="line"></span><br><span class="line">a + b <span class="comment">// [[2, 0, 0], [0, 2, 0], [0, 0, 2]]</span></span><br></pre></td></tr></table></figure>
<p>目前 QuickJS 也应该是仅有的支持这一能力的 JS 引擎。</p>
<p>上面这些是 QuickJS 支持的新语言特性。接下来聊聊它在运行时部分的更新。</p>
<p>我们知道，纯粹按规范实现的 JS 引擎是不管「副作用」的，甚至连设置定时器和打 log 都不支持。作为工程项目，引擎至少需要配套某种运行时来处理 IO（比如输出跑 Test262 的结果）。在 QuickJS 里这一点实现得很清晰，直接体现在了代码文件层面：</p>
<ul>
<li><code>quickjs.c</code> 对应整个引擎。</li>
<li><code>quickjs-libc.c</code> 对应运行时标准库，依赖引擎。</li>
<li><code>qjs.c</code> 对应可执行文件入口，依赖运行时。</li>
</ul>
<p>所以这里讲的就是 <code>quickjs-libc.c</code> 文件里的更新了。它主要提供了 os 和 std 两个开箱即用的模块，一年来新特性包括这些：</p>
<p><strong>os 模块</strong></p>
<ul>
<li><code>os.Worker</code></li>
<li><code>os.exec</code></li>
<li><code>os.chdir</code></li>
<li><code>os.realpath</code></li>
<li><code>os.getcwd</code></li>
<li><code>os.mkdir</code></li>
<li><code>os.stat</code></li>
<li><code>os.lstat</code></li>
<li><code>os.readlink</code></li>
<li><code>os.readdir</code></li>
<li><code>os.utimes</code></li>
</ul>
<p><strong>std 模块</strong></p>
<ul>
<li><code>std.parseExtJSON</code></li>
<li><code>std.loadFile</code></li>
<li><code>std.strerror</code></li>
<li><code>std.FILE.prototype.tello</code></li>
<li><code>std.popen</code></li>
<li><code>std.urlGet</code></li>
</ul>
<p>其中，最近版本里加入的 <code>os.Worker</code> 除了支持 message 通信外，还支持 <code>SharedArrayBuffer</code> 能力。社区原有的第三方运行时里，还没有提供这种支持。</p>
<p>另外从今年 4 月起，QuickJS 里的 JS 对象已经支持跨 Realm 了。这意味着和 iframe 类似地，同一份脚本里的变量可以存在于不同的 JSContext 中。</p>
<p>最后，在引擎的 C API 方面，则有这些新增：</p>
<ul>
<li><code>JS_GetRuntimeOpaque</code></li>
<li><code>JS_SetRuntimeOpaque</code></li>
<li><code>JS_NewUint32</code></li>
<li><code>JS_SetHostPromiseRejectionTracker</code></li>
<li><code>JS_GetTypedArrayBuffer</code></li>
<li><code>JS_ValueToAtom</code></li>
<li><code>JS_GetOwnPropertyNames</code></li>
<li><code>JS_GetOwnProperty</code></li>
<li><code>JS_NewPromiseCapability</code></li>
</ul>
<p>现在我们可以用 C API 来新建 Promise，也可以操作 TypedArray 了。另外像 <code>JS_NewRuntime</code> 和 <code>JS_Eval</code> 这类核心 API，一年来并没有出现 breaking change。在 API 稳定性上，它并不像很多前端项目那样「拥抱变化」，这方面还是挺令人放心的。</p>
<h2 id="社区生态与应用案例"><a href="#社区生态与应用案例" class="headerlink" title="社区生态与应用案例"></a>社区生态与应用案例</h2><p>上面这些内容，大家只要看看 <a href="https://bellard.org/quickjs/Changelog" target="_blank" rel="noopener">Changelog</a>  其实都很容易查到。但就算是这个信息，应该也是这个月才添加到了项目主页上。之前如果没有实际下载源码，官网上甚至都看不到具体的更新细节。这侧面体现出了 QuickJS 项目的另一个鲜明特点：在运营上非常「老派」。</p>
<p>QuickJS 的「社区」比起和广大前端开发者熟悉的「社区」，至少有这些不同：</p>
<ul>
<li>坚持用邮件列表，没有 issue 和 bug tracker。</li>
<li>从来只发布 tar 打包后的纯文本源码。</li>
<li>没有官方 Git 仓库，即便有了也不接受 PR。</li>
</ul>
<p>非常明显地，<strong>目前整个项目还是完全由 Fabrice 控制的</strong>。另一位合作者 Charlie Gordon（这名字是《献给阿尔吉侬的花束》的主角，可能是个假名）除了引擎刚发布时活跃过一个月，已经消失很久了。如果你反馈了一个冷门 bug，Fabrice 可能（迅速或隔好几天）回复你一句「it will be fixed in next release」。那么恭喜你，下个版本里这个 bug 一定会修掉。但具体什么时候有新版本，目测也没有人知道。另外对一些小白问题，Fabrice 也可能翻牌子秒回（我就遇到过）。</p>
<p>另一件可以肯定的事是，QuickJS 其实还没有「真正」开源，目前主页上只有一个非官方 <a href="https://github.com/horhof/quickjs" target="_blank" rel="noopener">GitHub 镜像</a>。Fabrice 近期表示他自己的仓库使用 Subversion 维护，这个仓库还不打算公开。这既可以解释为什么现在 <code>quickjs.c</code> 里能把 5 万多行引擎代码写在同一个文件里，也可以解释为什么它不接受 PR，因为我们拿到的「源码」可能已经是通过工具生成的了。</p>
<p>但这些都挡不住社区的兴趣，因为目前 QuickJS 所发布的代码，实际上是相当易用且清晰可读的。只要看过源码就能发现，在不玩拉马努金式的黑魔法时，Fabrice 写的工程代码就像高中课后习题答案一样简单直接，丝毫不拖泥带水。下面列举一些有趣的社区周边项目：</p>
<ul>
<li><a href="https://github.com/saghul/txiki.js" target="_blank" rel="noopener">txiki.js</a> 运行时基于 libuv 提供了类似 Node.js 的能力，作者是 libuv 的核心开发者。</li>
<li><a href="https://github.com/koush/vscode-quickjs-debug" target="_blank" rel="noopener">vscode-quickjs-debug</a> 提供了非官方的 VSCode 调试器支持，需要与作者 fork 出的定制版 QuickJS 配合使用。Fabrice 曾经对此表示会考虑加入调试器协议，可惜现在还没有进一步进展。</li>
<li><a href="https://github.com/justjake/quickjs-emscripten" target="_blank" rel="noopener">quickjs-emscripten</a> 可以在浏览器里基于编译到 WASM 的 QuickJS 建立 VM 沙盒，执行不可控的外部 JS 代码。</li>
<li><a href="https://github.com/ialex32x/unity-jsb" target="_blank" rel="noopener">unity-jsb</a> 支持在 Unity 游戏引擎里使用 JS，这时运算符重载特性相当重要。</li>
<li><a href="https://github.com/GodotExplorer/ECMAScript" target="_blank" rel="noopener">GodotExplorer/ECMAScript</a> 支持在 Godot 游戏引擎里使用 JS。顺带一提，它由知乎用户 at Geequlim 开发的。</li>
<li><a href="https://github.com/abner/flutter_js" target="_blank" rel="noopener">flutter_js</a> 支持在 Flutter 环境里执行 JS，它在安卓上会使用 QuickJS。不过注意这时实际的开发语言还是 Dart。</li>
<li><a href="https://github.com/saghul/wasi-lab/tree/master/qjs-wasi" target="_blank" rel="noopener">qjs-wasi</a> 支持基于新的 WASI 标准，把 <code>qjs</code> 可执行文件直接编译到浏览器里执行。</li>
<li><a href="https://github.com/galvez/fast-vue-ssr" target="_blank" rel="noopener">fast-vue-ssr</a> 刚刚推出，配合 Rust 上的高性能 Warp HTTP 框架来做 Vue 的 SSR。作者认为这种手法在多线程使用时，能兼备低资源消耗与高吞吐量。</li>
<li><a href="https://github.com/quickjs-zh/QuickJS" target="_blank" rel="noopener">quickjs-zh</a> 提供了 QuickJS 文档的中文翻译。</li>
</ul>
<p>目前社区也已经实现引擎到各大主流语言的 binding 了：</p>
<ul>
<li><a href="https://github.com/koush/quack" target="_blank" rel="noopener">Java</a></li>
<li><a href="https://github.com/ftk/quickjspp" target="_blank" rel="noopener">C++</a></li>
<li><a href="https://github.com/vmas/QuickJS.NET" target="_blank" rel="noopener">C#</a></li>
<li><a href="https://github.com/theduke/quickjs-rs" target="_blank" rel="noopener">Rust</a></li>
<li><a href="https://github.com/wspl/go-quickjs" target="_blank" rel="noopener">Go</a></li>
<li><a href="https://github.com/Coldzer0/QuickJS-Pascal" target="_blank" rel="noopener">Pascal</a></li>
<li><a href="https://github.com/PetterS/quickjs" target="_blank" rel="noopener">Python</a></li>
</ul>
<p>而对于移动端开发者，也有将引擎移植到 <a href="https://github.com/siuying/QuickJS-iOS" target="_blank" rel="noopener">iOS</a> 和 <a href="https://github.com/seven332/quickjs-android" target="_blank" rel="noopener">Android</a> 平台的示例项目供参考。另外引擎也可以通过 Chrome Labs 搞的 <a href="https://github.com/GoogleChromeLabs/jsvu" target="_blank" rel="noopener">jsvu</a> 这个 nvm 式的 version updater 来升级。</p>
<p>既然都贴了这么多链接，就顺便再列一些我之前写的相关文章吧。对我自己来说，很多计算机知识是在拿 QuickJS 尝试实现 idea 的路上才搞清楚的，因此也特别感谢这个项目。这里再分享一下：</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/104333176" target="_blank" rel="noopener">从 JS 引擎到 JS 运行时（上）</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/104501929" target="_blank" rel="noopener">从 JS 引擎到 JS 运行时（下）</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/97851599" target="_blank" rel="noopener">将前端技术栈移植到掌上游戏机</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/89574235" target="_blank" rel="noopener">将 React 渲染到嵌入式液晶屏</a></li>
</ul>
<p>上面列的这些都是纯技术项目，有没有一些面向最终用户的产品呢？目前已知的案例还比较少，但都不是「为了用而用」，可以说是找到了 QuickJS 与具体使用场景的契合性的。</p>
<p>首先，著名的 Web 设计工具 Figma 在邮件列表讨论（<a href="https://www.freelists.org/post/quickjs-devel/Bug-in-direct-eval-resolution" target="_blank" rel="noopener">这里</a>）中，表示他们已经将 QuickJS 编译到了 WASM，作为其 Web 编辑器的 JS 插件运行时了。这封邮件中反馈的 bug 与当时 QuickJS 的 eval 行为无法被 shadow 掉有关，对于沙盒来说这显然属于需要屏蔽的能力。</p>
<p>然后，Fabrice 自己其实默默地基于 QuickJS 做了个很不错的产品，也就是在线科学计算器<a href="http://numcalc.com/" target="_blank" rel="noopener">numcalc.com</a>，支持任意精度的复数、超越函数、泰勒级数和矩阵运算等能力，相当强大。这个项目的原理，其实就是把修改后的 <code>qjs</code> 命令行 REPL 环境完全搬到了浏览器里，有些更像是在展示极致的个人技术力：</p>
<ul>
<li>展示 libbf 支持任意精度的浮点数运算。</li>
<li>展示 QuickJS 独家支持运算符重载提案。</li>
<li>展示 QuickJS 可以编译到 WASM。</li>
</ul>
<p>说来也巧，这和 at 立党 最近在知乎上炒得很热的 <a href="https://github.com/lidangzzz/hedgehog-lab" target="_blank" rel="noopener">Hedgedog Lab</a> 有些异曲同工。不过其中一个是（自己徒手写出 JS 引擎、浮点运算库和 REPL 终端）把圆周率算到 10 亿位，另一个则是（基于社区的 transpiler、gpu.js 和 monaco 编辑器）把矩阵运算移到 GPU 做加速，可以（强行）说各有所长吧。论技术力对比的话 Fabrice 之高山仰止自不必多言，但这件事本身倒是很有趣，适合编个震惊体新闻：</p>
<blockquote>
<p>《震惊！天津相声演员与编程奇才争相开发在线 JS 计算器，最大输家竟是 Matlab！》</p>
</blockquote>
<p>补充一下，我司（厦门稿定科技）内部搭建的移动端 Hybrid 框架里也用到了 QuickJS，用于渲染富 Canvas 式的应用。相应项目目前还处于开发阶段，等后面实际落地后，应该会有更多进一步的分享。我们团队也有 HC 开放，欢迎感兴趣的小伙伴投递噢。</p>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><p>这里整理了一些现在使用 QuickJS 时，可能比较容易遇到的问题：</p>
<ul>
<li>目前引擎缺少官方支持的调试器，断点调试还是个问题（<code>debugger</code> 语句会被忽略）。社区版本里虽然支持了调试器，但只有试验性实现，无法保证稳定性。</li>
<li>QuickJS 虽然支持在不同线程依次操作 JSRuntime（注意不是并行 eval），但这种操作会导致一个 <a href="https://www.freelists.org/post/quickjs-devel/stackoverflow,2" target="_blank" rel="noopener">stack overflow 报错</a>，具体绕过方法在邮件列表里有详细介绍。</li>
<li>原生模块名要以 <code>.so</code> 结尾，否则 JS 代码虽然也可以正常完成模块解析并运行，但编译成字节码时会报错。</li>
<li>ESM 目前支持的都是相对路径，且模块名要显式以 <code>.js</code> 结尾。</li>
<li>移动端字节码要在 PC 端以相同版本的 QuickJS 编译，否则会出问题。</li>
<li>鉴于引擎基于引用计数做 GC，因此在用 C API 操作 JS 对象时，要手动以 <code>JS_DupValue</code> 和 <code>JS_FreeValue</code> 平衡引用计数，否则是无法通过退出 JSRuntime 时的 asset 检查的。</li>
<li>一些特殊语法的性能可能有问题。例如如果把 for 循环里的 <code>100000</code> 换成  <code>10e6</code>，会慢 20 倍以上。在这方面，源码目录里的 TODO 文件列出了很多还没做的优化，可供参考。</li>
<li>为引擎开发原生 API 时，需要手动检测并抛出 <code>JS_EXCEPTION</code> 异常，否则调试时可能完全没有 JS 的错误堆栈信息，会很懵逼。</li>
<li>目前引擎也还缺少 Profiler 工具，不过源码中有一些 micro benchmark 用例。其中可以用内置 API 拿到纳秒精度的时间，测试结果较为稳定。</li>
</ul>
<h2 id="对比总结"><a href="#对比总结" class="headerlink" title="对比总结"></a>对比总结</h2><p>评价 QuickJS 时一定要牢记一点，那就是这毕竟是个没有 JIT 的引擎，虽然比其他嵌入式 JS 引擎快很多，但性能仍然远不能和 V8 这种复杂得多的引擎相提并论。有了 JIT 后，理想条件下能实现 20 倍以上的性能提升（Google 的钱可没白烧啊）。作为解释器，QuickJS 的性能和 CPython 或不带 JIT 的 Lua 在同一级。基于它解释执行的 JS 代码，在移动端比起等价的 C++ 慢个上百倍都是完全有可能的。虽然对于 IO 密集的普通应用来说这也不是不能接受，但这方面我们也踩到过一些坑，有机会再单独写文章讨论。</p>
<p>相比 V8，更适合与 QuickJS 对比的 JS 引擎应该是 Hermes。这时不难发现 QuickJS 在同等性能下，实现了更高的规范支持度和更轻的量级（经过 at 黄玄 补充，Hermes 的体积没有 QuickJS 主页 benchmark 里写的 27M 那么夸张，应该在 1M 左右。但相比之下 QuickJS 只有 210KB），也同样支持编译到内部字节码格式来优化加载速度与代码体积。对于 Hermes 所适用的 Hybrid 应用场景，它应该也是个有力的候选项。</p>
<p>某种程度上说，带和不带 JIT 的 JS 引擎，区别就像手枪和重机枪一样大。这方面基于 Web 技术栈开发超轻量 GUI 应用的框架 <a href="https://sciter.com/" target="_blank" rel="noopener">Sciter</a> 很有发言权。它的作者在 HN 上讨论 QuickJS 时，表示过在这种场景下有两条路：</p>
<ul>
<li>依赖 JIT 黑魔法实现高性能。</li>
<li>自己将性能敏感部分用原生语言实现，保持 JS 的「胶水」特色。</li>
</ul>
<p>Sciter 就选择了后面这条，从而在体积和可嵌入性上做到了远超 Electron 的表现。这方面的专家是 at 龙泉寺扫地僧，这里就不班门弄斧了。</p>
<p>在个人理解里，目前的 QuickJS 在如下场景里都很有潜力：</p>
<ul>
<li>支撑移动端的 Hybrid UI，如 Hermes 之于 React Native。</li>
<li>嵌入式硬件的上层应用开发，类似 <a href="https://www.zhihu.com/question/363807522/answer/961295958" target="_blank" rel="noopener">Static TypeScript</a>。</li>
<li>Web 低代码平台的沙箱，如 Figma 的插件系统。</li>
<li>游戏引擎内的脚本子系统。</li>
<li>计算机基础知识的学习。</li>
<li>闲着无聊想折腾（划掉）。</li>
</ul>
<p>总之，一年来的 QuickJS 保持着进步，默默地在 <strong>small but complete</strong> 的方向上几乎做到了极致。它仍然具有鲜明的个人特色，毕竟寻常的项目不配出现在 Fabrice 的主页上。这位编程界超级英雄的风采，我们还能欣赏多久呢？应该把这个引擎当作一件玩具，还是一件武器呢？</p>
<p>这都不好说，不过现在尝鲜显然还不算太迟。</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Note/">Note</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Web/">Web</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://ewind.us/2020/quickjs-one-year-brief/" data-title="QuickJS 引擎一年见闻录 | ewind the doodler" data-tsina="undefined" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2020/fools-day-v8/"  title="前端工程师如何自制 V8 引擎">
 <strong>下一篇：</strong><br/> 
 <span>前端工程师如何自制 V8 引擎
</span>
</a>
</div>

</nav>

	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#特性更新简介"><span class="toc-number">1.</span> <span class="toc-text">特性更新简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#社区生态与应用案例"><span class="toc-number">2.</span> <span class="toc-text">社区生态与应用案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常见问题"><span class="toc-number">3.</span> <span class="toc-text">常见问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#对比总结"><span class="toc-number">4.</span> <span class="toc-text">对比总结</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="doodlewind" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript">
(function(e){var t="//cdn.jsdelivr.net/github-cards/1.0.2/";var r,i=0;var a=e.getElementsByTagName("meta");var n,d,l,c;for(r=0;r<a.length;r++){var s=a[r].getAttribute("name");var f=a[r].getAttribute("content");if(s==="gc:url"){n=f}else if(s==="gc:base"){t=f}else if(s==="gc:client-id"){d=f}else if(s==="gc:client-secret"){l=f}else if(s==="gc:theme"){c=f}}function u(t){if(e.querySelectorAll){return e.querySelectorAll("."+t)}var i=e.getElementsByTagName("div");var a=[];for(r=0;r<i.length;r++){if(~i[r].className.split(" ").indexOf(t)){a.push(i[r])}}return a}function g(e,t){return e.getAttribute("data-"+t)}function h(e){if(window.addEventListener){window.addEventListener("message",function(t){if(e.id===t.data.sender){e.height=t.data.height}},false)}}function v(r,a){a=a||n;if(!a){var s=g(r,"theme")||c||"default";a=t+"cards/"+s+".html"}var f=g(r,"user");var u=g(r,"repo");var v=g(r,"github");if(v){v=v.split("/");if(v.length&&!f){f=v[0];u=u||v[1]}}if(!f){return}i+=1;var o=g(r,"width");var m=g(r,"height");var b=g(r,"target");var w=g(r,"client-id")||d;var p=g(r,"client-secret")||l;var A="ghcard-"+f+"-"+i;var y=e.createElement("iframe");y.setAttribute("style","width:100%");y.setAttribute("id",A);y.setAttribute("frameborder",0);y.setAttribute("scrolling",0);y.setAttribute("allowtransparency",true);var E=a+"?user="+f+"&identity="+A;if(u){E+="&repo="+u}if(b){E+="&target="+b}if(w&&p){E+="&client_id="+w+"&client_secret="+p}y.src=E;y.width=o||Math.min(r.parentNode.clientWidth||400,400);if(m){y.height=m}h(y);r.parentNode.replaceChild(y,r);return y}var o=u("github-card");for(r=0;r<o.length;r++){v(o[r])}if(window.githubCard){window.githubCard.render=v}})(document);
</script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Note/" title="Note">Note<sup>142</sup></a></li>
		  
		
		  
			<li><a href="/categories/Scribble/" title="Scribble">Scribble<sup>26</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Web/" title="Web">Web<sup>72</sup></a></li>
			
		
			
				<li><a href="/tags/JS/" title="JS">JS<sup>54</sup></a></li>
			
		
			
				<li><a href="/tags/Summary/" title="Summary">Summary<sup>28</sup></a></li>
			
		
			
				<li><a href="/tags/Algorithms/" title="Algorithms">Algorithms<sup>19</sup></a></li>
			
		
			
				<li><a href="/tags/USTC/" title="USTC">USTC<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/macOS/" title="macOS">macOS<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Pattern/" title="Pattern">Pattern<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/Photography/" title="Photography">Photography<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/CSS/" title="CSS">CSS<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Assembly/" title="Assembly">Assembly<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Visualization/" title="Visualization">Visualization<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Vue/" title="Vue">Vue<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Blog/" title="Blog">Blog<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/React/" title="React">React<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/SQL/" title="SQL">SQL<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Travel/" title="Travel">Travel<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/JavaScript/" title="JavaScript">JavaScript<sup>2</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://ustc.life" target="_blank" title=" 科大学生导航主页">ustc.life</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.unichow.com" target="_blank" title=" hengyu">Art</a>
            
          </li>
        
          <li>
            
            	<a href="https://ring0.me" target="_blank" title=" boj">Ring0</a>
            
          </li>
        
          <li>
            
            	<a href="https://sqrt-1.me" target="_blank" title=" zzh">负一的平方根</a>
            
          </li>
        
          <li>
            
            	<a href="http://0x01.me" target="_blank" title=" wzb">机智的超立方体</a>
            
          </li>
        
          <li>
            
            	<a href="https://jenny42.com" target="_blank" title=" jenny42">Jenny&#39;s Life</a>
            
          </li>
        
          <li>
            
            	<a href="http://sadhen.com" target="_blank" title=" sadhen">Sadhen</a>
            
          </li>
        
          <li>
            
            	<a href="http://chenyuelili.com/" target="_blank" title=" chenyueli">快乐小小利</a>
            
          </li>
        
          <li>
            
            	<a href="https://richardcao.me/" target="_blank" title=" richardcao">Lifecycle</a>
            
          </li>
        
          <li>
            
            	<a href="https://wangbaiyuan.cn/" target="_blank" title=" BrainWang">王柏元的博客</a>
            
          </li>
        
    </ul>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/doodlewind" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		<a href="http://www.zhihu.com/people/doodlewind" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
	</div>
			
		
				<div class="cc-license">
          <a href="http://creativecommons.org/licenses/by-nd/4.0" class="cc-opacity" target="_blank">
            <img src="/img/cc-by-nd.svg" alt="Creative Commons" />
          </a>
        </div>
    

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a>
		Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a>
		Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>
		© 2020 
		
		<a href="/about" target="_blank" title="doodlewind">doodlewind</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan hidden id='cnzz_stat_icon_1260460098'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s23.cnzz.com/z_stat.php%3Fid%3D1260460098' type='text/javascript'%3E%3C/script%3E"));</script>

<!-- Analytics End -->

<!-- Totop Begin -->

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
