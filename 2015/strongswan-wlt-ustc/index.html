
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  
    <title>用 strongSwan 实现网络通一号多用 | ewind the doodler</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="doodlewind">
    

    
    <meta name="description" content="通过 strongSwan 这个 IPSec 实现，我们可以在一台开通网络通的虚拟机上连接多个手机、平板等终端设备，实现网络通的一号多用。以下是这个 VPN 搭建过程的一些记录。">
<meta name="keywords" content="Linux,Web,USTC">
<meta property="og:type" content="article">
<meta property="og:title" content="用 strongSwan 实现网络通一号多用">
<meta property="og:url" content="https://ewind.us/2015/strongswan-wlt-ustc/index.html">
<meta property="og:site_name" content="ewind the doodler">
<meta property="og:description" content="通过 strongSwan 这个 IPSec 实现，我们可以在一台开通网络通的虚拟机上连接多个手机、平板等终端设备，实现网络通的一号多用。以下是这个 VPN 搭建过程的一些记录。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://7u2gqx.com1.z0.glb.clouddn.com/用strongSwan实现网络通一号多用/virtualbox-network.png">
<meta property="og:image" content="http://7u2gqx.com1.z0.glb.clouddn.com/用strongSwan实现网络通一号多用/vpn-client-ios8.PNG">
<meta property="og:image" content="http://7u2gqx.com1.z0.glb.clouddn.com/用strongSwan实现网络通一号多用/isakmp-login.jpg">
<meta property="og:image" content="http://7u2gqx.com1.z0.glb.clouddn.com/用strongSwan实现网络通一号多用/isakmp-init.jpg">
<meta property="og:image" content="http://7u2gqx.com1.z0.glb.clouddn.com/用strongSwan实现网络通一号多用/esp.jpg">
<meta property="og:updated_time" content="2019-06-25T06:27:21.558Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="用 strongSwan 实现网络通一号多用">
<meta name="twitter:description" content="通过 strongSwan 这个 IPSec 实现，我们可以在一台开通网络通的虚拟机上连接多个手机、平板等终端设备，实现网络通的一号多用。以下是这个 VPN 搭建过程的一些记录。">
<meta name="twitter:image" content="http://7u2gqx.com1.z0.glb.clouddn.com/用strongSwan实现网络通一号多用/virtualbox-network.png">
<meta name="twitter:creator" content="@i94ewind">

    
    <link rel="alternative" href="/atom.xml" title="ewind the doodler" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/logo-app.png">
    <link rel="apple-touch-icon-precomposed" href="/img/logo-app.png">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="ewind the doodler" title="ewind the doodler"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="ewind the doodler">ewind the doodler</a></h1>
				<h2 class="blog-motto">我想超越这平凡的生活，注定现在就是漂泊</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" autocomplete="off" name="q" maxlength="20" placeholder="搜索" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/strongswan-wlt-ustc/" title="用 strongSwan 实现网络通一号多用" itemprop="url">用 strongSwan 实现网络通一号多用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="doodlewind" target="_blank" itemprop="author">doodlewind</a>
		
  <p class="article-time">
    <time datetime="2015-05-29T16:00:00.000Z" itemprop="datePublished"> 发表于 2015-05-30</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#How-it-works"><span class="toc-number">1.</span> <span class="toc-text">How it works</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#虚拟机的部署"><span class="toc-number">2.</span> <span class="toc-text">虚拟机的部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#网络设置"><span class="toc-number">2.1.</span> <span class="toc-text">网络设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#图形界面"><span class="toc-number">2.2.</span> <span class="toc-text">图形界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#命令行"><span class="toc-number">2.3.</span> <span class="toc-text">命令行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#strongSwan-的安装"><span class="toc-number">3.</span> <span class="toc-text">strongSwan 的安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装依赖"><span class="toc-number">3.1.</span> <span class="toc-text">安装依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编译源码"><span class="toc-number">3.2.</span> <span class="toc-text">编译源码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#证书的生成"><span class="toc-number">4.</span> <span class="toc-text">证书的生成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#概述"><span class="toc-number">4.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#根-CA"><span class="toc-number">4.2.</span> <span class="toc-text">根 CA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VPN-主机"><span class="toc-number">4.3.</span> <span class="toc-text">VPN 主机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端"><span class="toc-number">4.4.</span> <span class="toc-text">客户端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#strongSwan-的配置"><span class="toc-number">5.</span> <span class="toc-text">strongSwan 的配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#连接配置"><span class="toc-number">5.1.</span> <span class="toc-text">连接配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#身份认证配置"><span class="toc-number">5.2.</span> <span class="toc-text">身份认证配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#防火墙配置"><span class="toc-number">5.3.</span> <span class="toc-text">防火墙配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#网络通配置"><span class="toc-number">5.4.</span> <span class="toc-text">网络通配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS-解析"><span class="toc-number">5.5.</span> <span class="toc-text">DNS 解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署"><span class="toc-number">6.</span> <span class="toc-text">部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#VPN-服务器端"><span class="toc-number">6.1.</span> <span class="toc-text">VPN 服务器端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端-1"><span class="toc-number">6.2.</span> <span class="toc-text">客户端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#抓包分析"><span class="toc-number">7.</span> <span class="toc-text">抓包分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IKE-SA-连接的建立"><span class="toc-number">7.1.</span> <span class="toc-text">IKE SA 连接的建立</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#协商-IKE-安全提议"><span class="toc-number">7.1.1.</span> <span class="toc-text">协商 IKE 安全提议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用-DH-算法交换密钥材料"><span class="toc-number">7.1.2.</span> <span class="toc-text">使用 DH 算法交换密钥材料</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#身份认证"><span class="toc-number">7.1.3.</span> <span class="toc-text">身份认证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#建立-IPSec-SA"><span class="toc-number">7.2.</span> <span class="toc-text">建立 IPSec SA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据传输"><span class="toc-number">7.3.</span> <span class="toc-text">数据传输</span></a></li></ol></li></ol>
		
		</div>
		
		<p>通过 <a href="http://strongswan.org" target="_blank" rel="noopener">strongSwan</a> 这个 IPSec 实现，我们可以在一台开通网络通的虚拟机上连接多个手机、平板等终端设备，实现网络通的一号多用。以下是这个 VPN 搭建过程的一些记录。</p>
<a id="more"></a>
<h2 id="How-it-works"><a href="#How-it-works" class="headerlink" title="How it works"></a>How it works</h2><p>简要介绍部署的环境：主机是一台运行 Yosemite 的 MacBook Air。在主机环境下，通过 Virtualbox 安装了一台 Ubuntu 12.04 虚拟机，用于安装和配置 strongSwan，虚拟机的网络设置为桥接模式，经由主机的 <code>en0</code> 网卡，获得独立的 IP 地址。主机、虚拟机和准备连接的各个终端都位于同一个 ustcnet 热点的 Wi-Fi 环境下。</p>
<h2 id="虚拟机的部署"><a href="#虚拟机的部署" class="headerlink" title="虚拟机的部署"></a>虚拟机的部署</h2><h3 id="网络设置"><a href="#网络设置" class="headerlink" title="网络设置"></a>网络设置</h3><p>需要将虚拟机网卡设置为桥接模式，如下图所示。</p>
<p><img src="http://7u2gqx.com1.z0.glb.clouddn.com/用strongSwan实现网络通一号多用/virtualbox-network.png" alt="network-config"></p>
<h3 id="图形界面"><a href="#图形界面" class="headerlink" title="图形界面"></a>图形界面</h3><p>在 Virtualbox 的主界面中选中要运行的虚拟机，点击菜单栏上的 <code>运行</code> 按钮即可。</p>
<h3 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h3><p>可以在主机的终端界面，直接通过命令行启动或停止虚拟机，并可以支持无图形界面的运行模式，此时需通过主机的 ssh 功能连接到虚拟的命令行操作界面。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># start VM without GUI</span><br><span class="line">VBoxManage startvm Ubuntu --type headless</span><br><span class="line"></span><br><span class="line"># stop VM</span><br><span class="line">VBoxManage controlvm Ubuntu poweroff</span><br></pre></td></tr></table></figure>
<h2 id="strongSwan-的安装"><a href="#strongSwan-的安装" class="headerlink" title="strongSwan 的安装"></a>strongSwan 的安装</h2><p>由于 Ubuntu 软件源中 strongSwan 的版本较低，因此在这里选择手动编译安装最新版 strongSwan 软件包。</p>
<h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>首先是安装编译所需要的依赖。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apt-get install build-essential</span><br><span class="line">aptitude install libgmp10 libgmp3-dev libssl-dev pkg-config libpcsclite-dev libpam0g-dev</span><br></pre></td></tr></table></figure>
<h3 id="编译源码"><a href="#编译源码" class="headerlink" title="编译源码"></a>编译源码</h3><p>从 strongSwan 官网上下载最新版的源码，并编译安装。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget http://download.strongswan.org/strongswan-5.2.2.tar.bz2</span><br><span class="line">tar -jxvf strongswan-5.2.2.tar.bz2 &amp;&amp; cd strongswan-5.2.2</span><br><span class="line">./configure --prefix=/usr --sysconfdir=/etc  --enable-openssl --enable-nat-transport --disable-mysql --disable-ldap  --disable-static --enable-shared --enable-md4 --enable-eap-mschapv2 --enable-eap-aka --enable-eap-aka-3gpp2  --enable-eap-gtc --enable-eap-identity --enable-eap-md5 --enable-eap-peap --enable-eap-radius --enable-eap-sim --enable-eap-sim-file --enable-eap-simaka-pseudonym --enable-eap-simaka-reauth --enable-eap-simaka-sql --enable-eap-tls --enable-eap-tnc --enable-eap-ttls</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>完成后的 strongSwan 相关文件路径是 <code>/etc/ipsec.d</code>。下面的操作都是在此路径下进行的，且均需要 root 权限。</p>
<h2 id="证书的生成"><a href="#证书的生成" class="headerlink" title="证书的生成"></a>证书的生成</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>下面的过程一共会生成了 6 个文件，或者说 3 个公私钥对。其实，现有的 Web 安全解决方案，就是在基于可信第三方的公私钥加密体制下实现的。从而，对一个最基本的安全通信场景，我们需要以下的几份材料做身份验证，防止窃听、冒用、重放、中间人等攻击：</p>
<ul>
<li><strong>可信第三方（CA）</strong>的公钥（证书）和私钥</li>
<li><strong>发送方</strong>的公钥（证书）和私钥</li>
<li><strong>接收方</strong>的公钥（证书）和私钥</li>
</ul>
<p>而流程可以概括为：CA 手里有一个自己私钥，它先为通过私钥为自己签发 CA 证书，然后用以下材料，分别签发发送方（VPN 主机）和接收方（手机客户端）的证书：</p>
<ul>
<li>CA 的证书</li>
<li>CA 的私钥</li>
<li>其中一方的私钥</li>
</ul>
<p>下面的过程，实际上就是对这个概念的一个完整实现流程。注意，私钥名为 <code>xxxKey.pem</code>，而与其对应的证书名为 <code>xxxCert.pem</code>。</p>
<h3 id="根-CA"><a href="#根-CA" class="headerlink" title="根 CA"></a>根 CA</h3><p>先为根 CA 生成 <code>pem</code> 格式的私钥 <code>caKey.pem</code>，它的默认加密方式是 RSA。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipsec pki --gen --outform pem &gt; caKey.pem</span><br></pre></td></tr></table></figure>
<p>为安全起见，需要修改权限以免私钥泄露，即仅允许 root 用户读写，对其余用户不可见。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chmod 600 caKey.pem</span><br></pre></td></tr></table></figure>
<p>然后通过这个私钥，生成服务器端的证书 <code>caCert.pem</code>。生成时可以用 <code>--dn</code> 参数指定证书的一些信息，如 <code>C=CN</code> 代表国家，<code>CN=vpn.host.name</code> 为 VPN 主机的域名或 IP。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipsec pki --self --in caKey.pem \</span><br><span class="line"> --dn &quot;C=CN, O=strongSwan, CN=ewind CA&quot; \</span><br><span class="line"> --ca --outform pem &gt; caCert.pem</span><br></pre></td></tr></table></figure>
<p>查看并确认生成的 CA 证书信息。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipsec pki --print --in caCert.pem</span><br><span class="line">cert:      X509</span><br><span class="line">subject:  &quot;C=CN, O=strongSwan, CN=ewind CA&quot;</span><br><span class="line">issuer:   &quot;C=CN, O=strongSwan, CN=ewind CA&quot;</span><br><span class="line">validity:  not before May 26 16:31:26 2015, ok</span><br><span class="line">           not after  May 25 16:31:26 2018, ok (expires in 1092 days)</span><br><span class="line">serial:    47:a1:14:1a:e1:aa:aa:7b</span><br><span class="line">flags:     CA CRLSign self-signed </span><br><span class="line">subjkeyId: aa:93:42:8a:ca:64:d4:87:ed:f1:2e:2e:a1:e1:57:4a:a1:91:39:47</span><br><span class="line">pubkey:    RSA 2048 bits</span><br><span class="line">keyid:     35:46:58:9d:c8:0a:d7:06:41:1a:83:9c:73:cc:54:97:a8:a5:bf:0f</span><br><span class="line">subjkey:   aa:93:42:8a:ca:64:d4:87:ed:f1:2e:2e:a1:e1:57:4a:a1:91:39:47</span><br></pre></td></tr></table></figure>
<p>到此为止，我们就完成了 CA 的证书-私钥对的生成。</p>
<h3 id="VPN-主机"><a href="#VPN-主机" class="headerlink" title="VPN 主机"></a>VPN 主机</h3><p>接下来，为 VPN 主机生成证书。首先是私钥 <code>serverKey.pem</code> 的生成。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipsec pki --gen --outform pem &gt; serverKey.pem</span><br></pre></td></tr></table></figure>
<p>然后就可以用刚生成的私钥加上 CA 的公私钥对，生成 VPN 主机的证书 <code>serverCert.pem</code> 了，这里可以在 <code>--san</code> 参数中填入 VPN 主机的域名或 IP 地址。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipsec pki --pub --in serverKey.pem | ipsec pki --issue \</span><br><span class="line"> --cacert caCert.pem --cakey caKey.pem \</span><br><span class="line"> --dn &quot;C=CN, O=strongSwan, CN=vpn.doodlewind.us&quot; \</span><br><span class="line"> --san=&quot;vpn.doodlewind.us&quot; --flag serverAuth \</span><br><span class="line"> --flag ikeIntermediate --outform pem &gt; serverCert.pem</span><br></pre></td></tr></table></figure>
<p>完成后，查看并确认 VPN 主机的证书信息。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ipsec pki --print --in serverCert.pem</span><br><span class="line">cert:      X509</span><br><span class="line">subject:  &quot;C=CN, O=strongSwan, CN=vpn.doodlewind.us&quot;</span><br><span class="line">issuer:   &quot;C=CN, O=strongSwan, CN=ewind CA&quot;</span><br><span class="line">validity:  not before May 26 16:31:38 2015, ok</span><br><span class="line">           not after  May 25 16:31:38 2018, ok (expires in 1092 days)</span><br><span class="line">serial:    33:b7:36:70:69:f0:f1:ad</span><br><span class="line">altNames:  vpn.doodlewind.us</span><br><span class="line">flags:     serverAuth iKEIntermediate </span><br><span class="line">authkeyId: aa:93:42:8a:ca:64:d4:87:ed:f1:2e:2e:a1:e1:57:4a:a1:91:39:47</span><br><span class="line">subjkeyId: 18:75:28:78:4e:ba:fd:9d:30:f9:e3:2b:85:4c:3c:11:72:55:5b:64</span><br><span class="line">pubkey:    RSA 2048 bits</span><br><span class="line">keyid:     4b:98:2c:dc:e8:60:a0:d0:e6:ea:d8:39:cb:6e:7a:32:88:27:59:67</span><br><span class="line">subjkey:   18:75:28:78:4e:ba:fd:9d:30:f9:e3:2b:85:4c:3c:11:72:55:5b:64</span><br></pre></td></tr></table></figure>
<p>到此，VPN 主机的证书生成步骤就完成了。</p>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>客户端证书的生成步骤，和 VPN 主机的步骤是一致的。不同之处在于，由于客户端系统的格式兼容性问题，需要将 <code>pem</code> 格式的证书整合为 <code>p12</code> 格式。首先还是为客户端生成私钥。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipsec pki --gen --outform pem &gt; ewindKey.pem</span><br></pre></td></tr></table></figure>
<p>再用这个私钥加上 CA 的公私钥对，生成客户端的证书。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipsec pki --pub --in ewindKey.pem | ipsec pki --issue \</span><br><span class="line"> --cacert caCert.pem --cakey caKey.pem \</span><br><span class="line"> --dn &quot;C=CN, O=strongSwan, CN=ewind&quot; \</span><br><span class="line"> --outform pem &gt; ewindCert.pem</span><br></pre></td></tr></table></figure>
<p>下面按惯例确认客户端证书的信息，保证格式的正确性。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipsec pki --print --in ewindCert.pem</span><br><span class="line">cert:      X509</span><br><span class="line">subject:  &quot;C=CN, O=strongSwan, CN=ewind&quot;</span><br><span class="line">issuer:   &quot;C=CN, O=strongSwan, CN=ewind CA&quot;</span><br><span class="line">validity:  not before May 26 16:31:42 2015, ok</span><br><span class="line">           not after  May 25 16:31:42 2018, ok (expires in 1092 days)</span><br><span class="line">serial:    6a:ae:c3:8d:e6:78:2f:9b</span><br><span class="line">flags:     </span><br><span class="line">authkeyId: aa:93:42:8a:ca:64:d4:87:ed:f1:2e:2e:a1:e1:57:4a:a1:91:39:47</span><br><span class="line">subjkeyId: 58:06:f5:a5:2e:b5:f9:12:25:51:f0:bf:c1:3c:5e:10:13:52:c0:a7</span><br><span class="line">pubkey:    RSA 2048 bits</span><br><span class="line">keyid:     77:ef:cf:91:d4:0c:19:15:ab:b2:e2:eb:4e:2c:b6:91:20:a1:e2:42</span><br><span class="line">subjkey:   58:06:f5:a5:2e:b5:f9:12:25:51:f0:bf:c1:3c:5e:10:13:52:c0:a7</span><br></pre></td></tr></table></figure>
<p>在打包前，我们一共有 3 个 <code>xxxKey.pem</code> 格式的私钥和 3 个 <code>xxxCert.pem</code> 格式的证书。下面将它们分别归类到 strongSwan 的相应路径下。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mv caKey.pem serverKey.pem ewindKey.pem private/</span><br><span class="line">mv caCert.pem cacerts/</span><br><span class="line">mv serverCert.pem ewindCert.pem certs/</span><br></pre></td></tr></table></figure>
<p>接下来就可以执行 <code>p12</code> 格式证书的打包了，这里利用 <code>openssl</code> 软件包实现打包。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openssl pkcs12 -export -inkey private/ewindKey.pem \</span><br><span class="line"> -in certs/ewindCert.pem -name &quot;ewind&quot;\</span><br><span class="line"> -certfile cacerts/caCert.pem \</span><br><span class="line"> -caname &quot;ewind CA&quot; \</span><br><span class="line"> -out ewindCert.p12</span><br></pre></td></tr></table></figure>
<p>完成后，即可将虚拟机中的 <code>ewindCert.p12</code> 客户端证书文件与 <code>certs/caCert.pem</code> CA 根证书文件用 <code>vsftpd</code> 或 <code>rsync</code> 等工具传输到主机，再分发到客户端。大体操作即是在信任 CA 根证书后，添加客户端证书即可，在此不再赘述。</p>
<h2 id="strongSwan-的配置"><a href="#strongSwan-的配置" class="headerlink" title="strongSwan 的配置"></a>strongSwan 的配置</h2><h3 id="连接配置"><a href="#连接配置" class="headerlink" title="连接配置"></a>连接配置</h3><p>虚拟机环境下，这份经过精简的配置文件，可以支持 IKEv1 和 IKEv2 密钥交换。配置文件路径为 <code>/etc/ipsec.d</code>，直接用 <code>nano</code> 等编辑器替换原配置文件内容即可。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">config setup</span><br><span class="line">    strictcrlpolicy=no</span><br><span class="line">    uniqueids=no</span><br><span class="line">    </span><br><span class="line">conn ikev1</span><br><span class="line">    keyexchange=ikev1</span><br><span class="line">    authby=xauthpsk</span><br><span class="line">    xauth=server</span><br><span class="line">    left=%defaultroute</span><br><span class="line">    leftsubnet=0.0.0.0/0</span><br><span class="line">    leftfirewall=yes</span><br><span class="line">    right=%any</span><br><span class="line">    rightsubnet=10.11.0.0/24</span><br><span class="line">    rightsourceip=10.11.0.0/24</span><br><span class="line">    auto=add</span><br><span class="line">conn ikev2</span><br><span class="line">    keyexchange=ikev2</span><br><span class="line">    ike=aes256-sha1-modp1024!</span><br><span class="line">    esp=aes256-sha1!</span><br><span class="line">    dpdaction=clear</span><br><span class="line">    dpddelay=300s</span><br><span class="line">    rekey=no</span><br><span class="line">    left=%defaultroute</span><br><span class="line">    leftsubnet=0.0.0.0/0</span><br><span class="line">    leftauth=pubkey</span><br><span class="line">    leftcert=serverCert.pem</span><br><span class="line">    leftid=ikev2</span><br><span class="line">    right=%any</span><br><span class="line">    rightsourceip=10.11.1.0/24</span><br><span class="line">    rightauth=eap-mschapv2</span><br><span class="line">    rightsendcert=never</span><br><span class="line">    eap_identity=%any</span><br><span class="line">    auto=add</span><br></pre></td></tr></table></figure>
<p>在这份配置文件中，我们分别指定了客户端采用 IKEv1 和 IKEv2 时的相应配置。其中，IKEv1 的身份认证方式为 xauth，通过预共享密钥（PSK）实现。而 IKEv2 的身份认证方式为 EAP，相关参数在配置文件中已指定。</p>
<h3 id="身份认证配置"><a href="#身份认证配置" class="headerlink" title="身份认证配置"></a>身份认证配置</h3><p>为了添加用户，需要修改 strongSwan 的身份认证配置文件 <code>/etc/ipsec.secret</code>。一个可用的范例如下。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">: PSK &quot;pythondafahao&quot;</span><br><span class="line">ewind1 : XAUTH &quot;pythondafahao&quot;</span><br><span class="line"></span><br><span class="line">: RSA ewindCert.pem</span><br><span class="line">ewind2 : EAP &quot;pythondafahao&quot;</span><br></pre></td></tr></table></figure>
<h3 id="防火墙配置"><a href="#防火墙配置" class="headerlink" title="防火墙配置"></a>防火墙配置</h3><p>为了实现 VPN 的上网功能，需要允许端口转发功能。以下是一个可用的 iptables 配置命令集。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iptables -A INPUT -p udp --dport 500 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p udp --dport 4500 -j ACCEPT</span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"># 地址与上面地址池对应</span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.11.1.0/24 -o eth0 -j MASQUERADE</span><br><span class="line">iptables -A FORWARD -s 10.11.1.0/24 -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>为了避免每次虚拟机启动都要重新执行这些命令的情况，可以将以上命令写入 <code>/etc/rc.local</code> 的 <code>exit</code> 语句之前，实现配置脚本的开机自动执行。</p>
<p>如果在连接后出现客户端无法 DNS 解析的情况，可以额外执行下面的这一行。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -o eth0 ! -p esp -j SNAT --to-source &quot;114.214.195.95&quot;</span><br></pre></td></tr></table></figure>
<h3 id="网络通配置"><a href="#网络通配置" class="headerlink" title="网络通配置"></a>网络通配置</h3><p>可以通过 bash 脚本直接启用网络通对虚拟机 IP 地址的出校权限，具体实现如下。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -c /tmp/wlt &quot;http://wlt.ustc.edu.cn/cgi-bin/ip?cmd=login&amp;name=yourname&amp;password=yourpass&quot; &gt; /dev/null</span><br><span class="line">curl -b /tmp/wlt &quot;http://wlt.ustc.edu.cn/cgi-bin/ip?cmd=set&amp;type=8&amp;exp=0&quot; &gt; /dev/null </span><br><span class="line">rm /tmp/wlt</span><br></pre></td></tr></table></figure>
<p>替换以上脚本中的 <code>yourname</code> 和 <code>yourpassword</code> 参数为网络通帐号和密码，即可使用该脚本。而最后一行中，设置 <code>type-x</code> 将指定网络通的出口号，<code>exp=y</code> 指定了有效期，置零代表永久有效（到下一次更新为止）。</p>
<h3 id="DNS-解析"><a href="#DNS-解析" class="headerlink" title="DNS 解析"></a>DNS 解析</h3><p>由于在前面采用了域名的方式指定 VPN 服务器地址，因此，需要在 DNS 服务提供商（这里采用了 <a href="http://dnspod.cn/" target="_blank" rel="noopener">DNSPod</a>）处，将相应的域名指向虚拟机的 IP 地址。这个 IP 地址可以在虚拟机的终端内用如下命令得到：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ifconfig | grep inet</span><br></pre></td></tr></table></figure>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><h3 id="VPN-服务器端"><a href="#VPN-服务器端" class="headerlink" title="VPN 服务器端"></a>VPN 服务器端</h3><p>完成 strongSwan 及其相关环境的设置后，即可启动 stongSwan。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipsec start</span><br></pre></td></tr></table></figure>
<p>若需要部署过程的详细日志，可以为启动命令附带参数。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipsec start --nofork</span><br></pre></td></tr></table></figure>
<p>然后就可以在终端窗口看到 strongSwan 的日志信息了。</p>
<h3 id="客户端-1"><a href="#客户端-1" class="headerlink" title="客户端"></a>客户端</h3><p>对支持 IKEv2 的操作系统（如运行 iOS 8 的 iPhone 设备），可以在 <code>设置 -&gt; 通用 -&gt; VPN -&gt; 添加 VPN 配置 -&gt; IPSec</code> 中看到图形化的 VPN 连接界面。在 <code>描述</code> 中填入任意的标题，在 <code>服务器</code> 中填入生成服务器端证书时的域名，在 <code>账户</code> 中填入 /etc/ipsec.secrets 中采用 EAP 加密时的密码，在 <code>密钥</code> 中则填入使用 PSK 时的预共享密钥即可。</p>
<p>完成后，选择 <code>通用 -&gt; VPN -&gt; 连接</code> 即可一键连接到搭建好的 IPSec VPN 了！</p>
<p><img src="http://7u2gqx.com1.z0.glb.clouddn.com/用strongSwan实现网络通一号多用/vpn-client-ios8.PNG" alt="cliend-iOS8"></p>
<h2 id="抓包分析"><a href="#抓包分析" class="headerlink" title="抓包分析"></a>抓包分析</h2><p>抓包分析在 OS X Yosemite 环境下进行。由于该系统下 Wireshark 暂时不能正常使用，因此使用 CocoaPacketAnalyzer 做抓包工具。</p>
<h3 id="IKE-SA-连接的建立"><a href="#IKE-SA-连接的建立" class="headerlink" title="IKE SA 连接的建立"></a>IKE SA 连接的建立</h3><p>以 iPhone 5C 登录 VPN 为例，演示连接过程的建立。</p>
<p>其中，iPhone 5C 的 IP 地址为 <code>114.214.184.203</code>，VPN 主机的 IP 地址为 <code>222.195.85.154</code>。</p>
<p>由于 CocoaPacketAnalyzer 不支持 ISAKMP 协议的分析，故将过滤方式选取为 UDP 500 端口，分析连接建立过程中 ISAKMP 协议的协商过程。</p>
<p>由于 iPhone 5C 默认的 IPSec 客户端设置为 PSK 预共享密钥形式，故在密钥协商时采用了 IKEv1 协议（配置文件中支持 IKEv2，但在连接建立时回退到了 IKEv1）。</p>
<p><img src="http://7u2gqx.com1.z0.glb.clouddn.com/用strongSwan实现网络通一号多用/isakmp-login.jpg" alt="isakmp-login"></p>
<p>通过以上高亮的 6 条报文，建立了连接。其过程如下：</p>
<h4 id="协商-IKE-安全提议"><a href="#协商-IKE-安全提议" class="headerlink" title="协商 IKE 安全提议"></a>协商 IKE 安全提议</h4><p>前 2 条报文用于协商 IKE 安全提议。协商分两种情况：</p>
<ol>
<li>发起方的 IKE Peer 中引用了 IKE Proposal</li>
<li>发起方的 IKE Peer 中没有引用 IKE Proposal</li>
</ol>
<p>两种情况下，响应方都会在自己配置的 IKE 安全提议中寻找与发送方相匹配的 IKE 安全提议，如果没有匹配的安全提议则协商失败。IKE Peer 双方安全提议匹配的原则为协商双方有相同的加密算法、认证算法、身份认证方法和 DH 组标识（不包括 IKE SA 生存周期）。</p>
<p><img src="http://7u2gqx.com1.z0.glb.clouddn.com/用strongSwan实现网络通一号多用/isakmp-init.jpg" alt="isakmp-init"></p>
<p>此即由 iPhone 发起的第一条报文，其载荷长度也是所有报文中最长的。通过 strongSwan 的日志，可以发现这也与日志内容相匹配。这里 iPhone 发起的连接采用了 Main Mode 主模式，而非 Aggressive Mode 积极模式。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 发送安全提议与确认安全提议</span><br><span class="line">15[IKE] 114.214.184.203 is initiating a Main Mode IKE_SA</span><br><span class="line">15[NET] sending packet: from 222.195.85.154[500] to 114.214.184.203[500] (136 bytes)</span><br></pre></td></tr></table></figure>
<h4 id="使用-DH-算法交换密钥材料"><a href="#使用-DH-算法交换密钥材料" class="headerlink" title="使用 DH 算法交换密钥材料"></a>使用 DH 算法交换密钥材料</h4><p>第 3 条和第 4 条报文中，双方使用 DH 算法交换密钥材料，并生成密钥。由于抓包工具无法查看载荷的内容，故通过 strongSwan 日志文件分析其内容。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 交换密钥信息并生成密钥</span><br><span class="line">16[NET] received packet: from 114.214.184.203[500] to 222.195.85.154[500] (228 bytes)</span><br><span class="line">16[ENC] parsed ID_PROT request 0 [ KE No NAT-D NAT-D ]</span><br><span class="line">16[ENC] generating ID_PROT response 0 [ KE No NAT-D NAT-D ]</span><br><span class="line">16[NET] sending packet: from 222.195.85.154[500] to 114.214.184.203[500] (244 bytes)</span><br></pre></td></tr></table></figure>
<p>这两条报文中包含了用于密钥协商的载荷 <code>KE</code> 和临时随机数 <code>No</code>，虽然其通过 UDP 协议明文发送，但 DH 算法保证了即便该载荷被窃听，也无法分析出密钥协商结果。</p>
<h4 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h4><p>第 5 条和第 6 条报文中，IKE Peer 双方交换身份信息，进行身份认证。</p>
<p>目前有两种身份认证技术比较常用：</p>
<ol>
<li>预共享密钥方式（Pre Share Key）：设备的身份信息为IP地址或名称。</li>
<li>数字证书方式：设备的身份信息为证书和通过证书私钥加密的部分消息 Hash 值</li>
</ol>
<p>在此指定了常用于 iPhone 的 PSK 方式进行身份认证，故而没有使用预先为客户端签发的证书。若在 Windows 等系统环境下，可以利用之前签发的 <code>ewindCert.p12</code> 客户端证书文件进行身份认证。这个认证过程中的日志记录如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 交换身份信息，认证对方身份</span><br><span class="line">06[NET] received packet: from 114.214.184.203[500] to 222.195.85.154[500] (108 bytes)</span><br><span class="line">06[ENC] parsed ID_PROT request 0 [ ID HASH N(INITIAL_CONTACT) ]</span><br><span class="line">06[CFG] looking for XAuthInitPSK peer configs matching 222.195.85.154...114.214.184.203[114.214.184.203]</span><br><span class="line">06[CFG] selected peer config &quot;ikev1&quot;</span><br><span class="line">06[ENC] generating ID_PROT response 0 [ ID HASH ]</span><br><span class="line">06[NET] sending packet: from 222.195.85.154[500] to 114.214.184.203[500] (76 bytes)</span><br></pre></td></tr></table></figure>
<p>由于身份认证信息经过了 DH 算法交换生成的密钥的加密，故而保证了这两条 UDP 消息的安全性。</p>
<h3 id="建立-IPSec-SA"><a href="#建立-IPSec-SA" class="headerlink" title="建立 IPSec SA"></a>建立 IPSec SA</h3><p>在完成 IKE SA 的建立后，就是 IPSec SA 的建立了。其过程如下：</p>
<ol>
<li>发起方发送 IPSec 安全提议、被保护的数据流（ACL）和密钥材料给响应方。</li>
<li>响应方回应匹配的 IPSec 安全提议、被保护的数据流，同时双方生成用于 IPSec SA 的密钥。</li>
<li>发起方发送确认结果。</li>
</ol>
<p>协商完成后发送方开始发送 IPSec（ESP）报文。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 完成认证后，用 3 条消息建立 IPSec SA</span><br><span class="line">06[ENC] generating TRANSACTION request 3977700787 [ HASH CPRQ(X_USER X_PWD) ]</span><br><span class="line">06[NET] sending packet: from 222.195.85.154[500] to 114.214.184.203[500] (76 bytes)</span><br><span class="line">05[NET] received packet: from 114.214.184.203[500] to 222.195.85.154[500] (92 bytes)</span><br><span class="line">05[ENC] parsed TRANSACTION response 3977700787 [ HASH CPRP(X_USER X_PWD) ]</span><br><span class="line">05[IKE] XAuth authentication of &apos;ewind2&apos; successful</span><br><span class="line">05[ENC] generating TRANSACTION request 3335483661 [ HASH CPS(X_STATUS) ]</span><br><span class="line">05[NET] sending packet: from 222.195.85.154[500] to 114.214.184.203[500] (76 bytes)</span><br><span class="line">04[NET] received packet: from 114.214.184.203[500] to 222.195.85.154[500] (76 bytes)</span><br><span class="line">04[ENC] parsed TRANSACTION response 3335483661 [ HASH CPA(X_STATUS) ]</span><br><span class="line">04[IKE] IKE_SA ikev1[1] established between 222.195.85.154[222.195.85.154]...114.214.184.203[114.214.184.203]</span><br></pre></td></tr></table></figure>
<h3 id="数据传输"><a href="#数据传输" class="headerlink" title="数据传输"></a>数据传输</h3><p>在完成上文的 ISAKMP 协商过程后，通信双方即开始发送 IPSec（ESP）报文。</p>
<p><img src="http://7u2gqx.com1.z0.glb.clouddn.com/用strongSwan实现网络通一号多用/esp.jpg" alt="esp"></p>
<p>在上图中筛选出了由 iPhone 客户端到 VPN 主机之间的报文。其中的明文信息有 ESP 格式载荷的 SPI 号和序列号，而其载荷内容经过加密而无法查看。</p>
<p>由于图中的报文的 SPI 号是相同的，据此可以推断出它们是在同一条 SA 连接上传输的。</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Note/">Note</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/Web/">Web</a><a href="/tags/USTC/">USTC</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://ewind.us/2015/strongswan-wlt-ustc/" data-title="用 strongSwan 实现网络通一号多用 | ewind the doodler" data-tsina="2804097783" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/complier-open-courseware/" title="编译原理公开课资源">
  <strong>上一篇：</strong><br/>
  <span>
  编译原理公开课资源</span>
</a>
</div>


<div class="next">
<a href="/2015/finder-sort-find/"  title="Finder 的文件排序与两条捷径">
 <strong>下一篇：</strong><br/> 
 <span>Finder 的文件排序与两条捷径
</span>
</a>
</div>

</nav>

	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#How-it-works"><span class="toc-number">1.</span> <span class="toc-text">How it works</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#虚拟机的部署"><span class="toc-number">2.</span> <span class="toc-text">虚拟机的部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#网络设置"><span class="toc-number">2.1.</span> <span class="toc-text">网络设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#图形界面"><span class="toc-number">2.2.</span> <span class="toc-text">图形界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#命令行"><span class="toc-number">2.3.</span> <span class="toc-text">命令行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#strongSwan-的安装"><span class="toc-number">3.</span> <span class="toc-text">strongSwan 的安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装依赖"><span class="toc-number">3.1.</span> <span class="toc-text">安装依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编译源码"><span class="toc-number">3.2.</span> <span class="toc-text">编译源码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#证书的生成"><span class="toc-number">4.</span> <span class="toc-text">证书的生成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#概述"><span class="toc-number">4.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#根-CA"><span class="toc-number">4.2.</span> <span class="toc-text">根 CA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VPN-主机"><span class="toc-number">4.3.</span> <span class="toc-text">VPN 主机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端"><span class="toc-number">4.4.</span> <span class="toc-text">客户端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#strongSwan-的配置"><span class="toc-number">5.</span> <span class="toc-text">strongSwan 的配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#连接配置"><span class="toc-number">5.1.</span> <span class="toc-text">连接配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#身份认证配置"><span class="toc-number">5.2.</span> <span class="toc-text">身份认证配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#防火墙配置"><span class="toc-number">5.3.</span> <span class="toc-text">防火墙配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#网络通配置"><span class="toc-number">5.4.</span> <span class="toc-text">网络通配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS-解析"><span class="toc-number">5.5.</span> <span class="toc-text">DNS 解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署"><span class="toc-number">6.</span> <span class="toc-text">部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#VPN-服务器端"><span class="toc-number">6.1.</span> <span class="toc-text">VPN 服务器端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端-1"><span class="toc-number">6.2.</span> <span class="toc-text">客户端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#抓包分析"><span class="toc-number">7.</span> <span class="toc-text">抓包分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IKE-SA-连接的建立"><span class="toc-number">7.1.</span> <span class="toc-text">IKE SA 连接的建立</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#协商-IKE-安全提议"><span class="toc-number">7.1.1.</span> <span class="toc-text">协商 IKE 安全提议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用-DH-算法交换密钥材料"><span class="toc-number">7.1.2.</span> <span class="toc-text">使用 DH 算法交换密钥材料</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#身份认证"><span class="toc-number">7.1.3.</span> <span class="toc-text">身份认证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#建立-IPSec-SA"><span class="toc-number">7.2.</span> <span class="toc-text">建立 IPSec SA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据传输"><span class="toc-number">7.3.</span> <span class="toc-text">数据传输</span></a></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="doodlewind" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript">
(function(e){var t="//cdn.jsdelivr.net/github-cards/1.0.2/";var r,i=0;var a=e.getElementsByTagName("meta");var n,d,l,c;for(r=0;r<a.length;r++){var s=a[r].getAttribute("name");var f=a[r].getAttribute("content");if(s==="gc:url"){n=f}else if(s==="gc:base"){t=f}else if(s==="gc:client-id"){d=f}else if(s==="gc:client-secret"){l=f}else if(s==="gc:theme"){c=f}}function u(t){if(e.querySelectorAll){return e.querySelectorAll("."+t)}var i=e.getElementsByTagName("div");var a=[];for(r=0;r<i.length;r++){if(~i[r].className.split(" ").indexOf(t)){a.push(i[r])}}return a}function g(e,t){return e.getAttribute("data-"+t)}function h(e){if(window.addEventListener){window.addEventListener("message",function(t){if(e.id===t.data.sender){e.height=t.data.height}},false)}}function v(r,a){a=a||n;if(!a){var s=g(r,"theme")||c||"default";a=t+"cards/"+s+".html"}var f=g(r,"user");var u=g(r,"repo");var v=g(r,"github");if(v){v=v.split("/");if(v.length&&!f){f=v[0];u=u||v[1]}}if(!f){return}i+=1;var o=g(r,"width");var m=g(r,"height");var b=g(r,"target");var w=g(r,"client-id")||d;var p=g(r,"client-secret")||l;var A="ghcard-"+f+"-"+i;var y=e.createElement("iframe");y.setAttribute("style","width:100%");y.setAttribute("id",A);y.setAttribute("frameborder",0);y.setAttribute("scrolling",0);y.setAttribute("allowtransparency",true);var E=a+"?user="+f+"&identity="+A;if(u){E+="&repo="+u}if(b){E+="&target="+b}if(w&&p){E+="&client_id="+w+"&client_secret="+p}y.src=E;y.width=o||Math.min(r.parentNode.clientWidth||400,400);if(m){y.height=m}h(y);r.parentNode.replaceChild(y,r);return y}var o=u("github-card");for(r=0;r<o.length;r++){v(o[r])}if(window.githubCard){window.githubCard.render=v}})(document);
</script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Note/" title="Note">Note<sup>135</sup></a></li>
		  
		
		  
			<li><a href="/categories/Scribble/" title="Scribble">Scribble<sup>25</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Web/" title="Web">Web<sup>66</sup></a></li>
			
		
			
				<li><a href="/tags/JS/" title="JS">JS<sup>51</sup></a></li>
			
		
			
				<li><a href="/tags/Summary/" title="Summary">Summary<sup>27</sup></a></li>
			
		
			
				<li><a href="/tags/Algorithms/" title="Algorithms">Algorithms<sup>19</sup></a></li>
			
		
			
				<li><a href="/tags/USTC/" title="USTC">USTC<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/macOS/" title="macOS">macOS<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Photography/" title="Photography">Photography<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/Pattern/" title="Pattern">Pattern<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/CSS/" title="CSS">CSS<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Assembly/" title="Assembly">Assembly<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Visualization/" title="Visualization">Visualization<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/React/" title="React">React<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Blog/" title="Blog">Blog<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Vue/" title="Vue">Vue<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/SQL/" title="SQL">SQL<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/JavaScript/" title="JavaScript">JavaScript<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Travel/" title="Travel">Travel<sup>2</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://ustc.life" target="_blank" title=" 科大学生导航主页">ustc.life</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.unichow.com" target="_blank" title=" hengyu">Art</a>
            
          </li>
        
          <li>
            
            	<a href="https://ring0.me" target="_blank" title=" boj">Ring0</a>
            
          </li>
        
          <li>
            
            	<a href="https://sqrt-1.me" target="_blank" title=" zzh">负一的平方根</a>
            
          </li>
        
          <li>
            
            	<a href="http://0x01.me" target="_blank" title=" wzb">机智的超立方体</a>
            
          </li>
        
          <li>
            
            	<a href="https://jenny42.com" target="_blank" title=" jenny42">Jenny&#39;s Life</a>
            
          </li>
        
          <li>
            
            	<a href="http://sadhen.com" target="_blank" title=" sadhen">Sadhen</a>
            
          </li>
        
          <li>
            
            	<a href="http://chenyuelili.com/" target="_blank" title=" chenyueli">快乐小小利</a>
            
          </li>
        
          <li>
            
            	<a href="https://richardcao.me/" target="_blank" title=" richardcao">Lifecycle</a>
            
          </li>
        
          <li>
            
            	<a href="https://wangbaiyuan.cn/" target="_blank" title=" BrainWang">王柏元的博客</a>
            
          </li>
        
    </ul>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> I&#39;m a Chinese web developer. <br/>
			Hope you like my blog.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2804097783" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/doodlewind" target="_blank" class="icon-github" title="github"></a>
		
		
		
		<a href="https://twitter.com/i94ewind" target="_blank" class="icon-twitter" title="twitter"></a>
		
		
		<a href="https://www.facebook.com/doodlewind" target="_blank" class="icon-facebook" title="facebook"></a>
		
		
		<a href="https://www.linkedin.com/in/doodlewind" target="_blank" class="icon-linkedin" title="linkedin"></a>
		
		
		
		<a href="http://www.zhihu.com/people/doodlewind" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
		<a href="mailto:doodlewind@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		
				<div class="cc-license">
          <a href="http://creativecommons.org/licenses/by-nd/4.0" class="cc-opacity" target="_blank">
            <img src="/img/cc-by-nd.svg" alt="Creative Commons" />
          </a>
        </div>
    

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a>
		Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a>
		Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>
		© 2019 
		
		<a href="/about" target="_blank" title="doodlewind">doodlewind</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan hidden id='cnzz_stat_icon_1260460098'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s23.cnzz.com/z_stat.php%3Fid%3D1260460098' type='text/javascript'%3E%3C/script%3E"));</script>

<!-- Analytics End -->

<!-- Totop Begin -->

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
