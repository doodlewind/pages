
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  
    <title>自制前端框架之 MVC | ewind the doodler</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="doodlewind">
    

    
    <meta name="description" content="MVC 是 UI 编程领域中非常经典的设计模式，使得开发者能够借助该模式，构建出更易于扩展和维护的应用程序。在本文中，我们将基于经典的 MVC 理念，实现一个 50 行内的极简 MVC 框架，用于支持一个 Todo App 示例应用的开发。文末附有示例 Github 地址。">
<meta name="keywords" content="JS,Pattern">
<meta property="og:type" content="article">
<meta property="og:title" content="自制前端框架之 MVC">
<meta property="og:url" content="https://ewind.us/2017/nano-mvc/index.html">
<meta property="og:site_name" content="ewind the doodler">
<meta property="og:description" content="MVC 是 UI 编程领域中非常经典的设计模式，使得开发者能够借助该模式，构建出更易于扩展和维护的应用程序。在本文中，我们将基于经典的 MVC 理念，实现一个 50 行内的极简 MVC 框架，用于支持一个 Todo App 示例应用的开发。文末附有示例 Github 地址。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-03-31T14:41:36.227Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="自制前端框架之 MVC">
<meta name="twitter:description" content="MVC 是 UI 编程领域中非常经典的设计模式，使得开发者能够借助该模式，构建出更易于扩展和维护的应用程序。在本文中，我们将基于经典的 MVC 理念，实现一个 50 行内的极简 MVC 框架，用于支持一个 Todo App 示例应用的开发。文末附有示例 Github 地址。">

    
    <link rel="alternative" href="/atom.xml" title="ewind the doodler" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/logo-app.png">
    <link rel="apple-touch-icon-precomposed" href="/img/logo-app.png">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="ewind the doodler" title="ewind the doodler"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="ewind the doodler">ewind the doodler</a></h1>
				<h2 class="blog-motto">我想超越这平凡的生活，注定现在就是漂泊</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" autocomplete="off" name="q" maxlength="20" placeholder="搜索" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/nano-mvc/" title="自制前端框架之 MVC" itemprop="url">自制前端框架之 MVC</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="doodlewind" target="_blank" itemprop="author">doodlewind</a>
		
  <p class="article-time">
    <time datetime="2017-07-13T16:00:00.000Z" itemprop="datePublished"> 发表于 2017-07-14</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介与动机"><span class="toc-number">1.</span> <span class="toc-text">简介与动机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#框架特性"><span class="toc-number">2.</span> <span class="toc-text">框架特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用示例"><span class="toc-number">3.</span> <span class="toc-text">使用示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编码实现"><span class="toc-number">4.</span> <span class="toc-text">编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Model-模块"><span class="toc-number">4.1.</span> <span class="toc-text">Model 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Controller-模块"><span class="toc-number">4.2.</span> <span class="toc-text">Controller 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#View-模块"><span class="toc-number">4.3.</span> <span class="toc-text">View 模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol>
		
		</div>
		
		<p>MVC 是 UI 编程领域中非常经典的设计模式，使得开发者能够借助该模式，构建出更易于扩展和维护的应用程序。在本文中，我们将基于经典的 MVC 理念，实现一个 50 行内的极简 MVC 框架，用于支持一个 Todo App 示例应用的开发。文末附有示例 Github 地址。</p>
<a id="more"></a>
<h2 id="简介与动机"><a href="#简介与动机" class="headerlink" title="简介与动机"></a>简介与动机</h2><p>MVC 模式在概念上，强调 Model / View / Controller 三个模块的分离：</p>
<ul>
<li><strong>Model</strong>: 专注数据的存取，对基础数据对象的封装。</li>
<li><strong>Controller</strong>: 处理形如【用户登录】、【验证表单】等具体操作时的业务逻辑，从 Model 中存取数据，并渲染到 View 中。</li>
<li><strong>View</strong>: 负责界面视图，可理解为【输入数据，输出界面】的模块，在其中通常不涉及的业务逻辑。</li>
</ul>
<p>需要注意的是，MVC 仅是一种模式理念，而非具体的规范。因此，根据 MVC 的理念所设计出的框架，在实现和使用上可能存在着较大的区别。下文中介绍的框架，仅是作者作为示例给出的一种实现，供读者参考。</p>
<p>那么，为什么需要 MVC 这一框架级的设计模式呢？相信许多前端开发者都经历过纯粹基于 jQuery / Zepto 等基础类库开发前端项目的阶段。在这种情境下，完全不需要考虑 MVC 的概念，对业务逻辑的实现是非常简单而直接的。以实现【点击某按钮时，从后台接口获取数据，然后渲染到页面】这样非常常见的需求为例，典型的业务代码实现形如：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 点击某按钮时</span></span><br><span class="line">$(<span class="string">'.xx-btn'</span>).click(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 从后台接口获取数据</span></span><br><span class="line">  $.<span class="keyword">get</span>('/xx-api', (data) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 拼接模板</span></span><br><span class="line">    <span class="keyword">const</span> template = <span class="string">`&lt;div&gt;<span class="subst">$&#123;data&#125;</span>&lt;/div&gt;`</span></span><br><span class="line">    <span class="comment">// 渲染到页面上</span></span><br><span class="line">    $(<span class="string">'#xx-table'</span>).html(template)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>基于这些便捷的 API，确实能在寥寥数行之内实现业务需求。这时，存在的问题包括：</p>
<ul>
<li>处理【用户输入】与【数据渲染】的逻辑，以硬编码的形式结合在了一起，一般项目中数据渲染的代码多直接书写在匿名回调函数内，难以抽离复用（尤其是在回调函数内使用了 <code>this</code> 时，更难复用相应的渲染代码）。</li>
<li>在没有 ES6 的时代，字符串拼接的代码十分难以维护，各种形如 <code>&#39;&lt;div class=&quot;&#39; + data.class + &#39;&quot;&gt;&#39;</code> 这样引号交错的代码虽然容易符合初学者的直觉写出，但显然难以阅读和维护。</li>
<li>将数据直接映射到页面 DOM 上的操作同样很符合初学者的直觉，但也造成应用数据模型的缺乏。在页面【存在多种可能的输入，而每种输入所对应的输出均可直接修改 DOM 结构】时，会带来陡增的状态复杂性。</li>
</ul>
<p>虽然 MVC 不是银弹，但其出现确实提供了一种解决上述问题的思路。下文中将从一个极简的 MVC 框架所需要具备的特性出发，一步步介绍我们解决上述问题的思路。</p>
<h2 id="框架特性"><a href="#框架特性" class="headerlink" title="框架特性"></a>框架特性</h2><p>与许多设计模式一样，MVC 在概念定义上较为抽象，通过代码实现掌握它，显然比模糊的文字描述要更为有效。下面作为示例，我们将一步步实现这个名为 NanoMVC 的框架。</p>
<p>在开始编写具体代码之前，需要在设计阶段明确的是，这个框架将提供何种功能，使用者该如何使用。基于使用情景的需求，给出一些简单的示例代码，最后再从满足这些示例的目标出发，进行实际的编码实现。在【先明确需求，再进行编码实现】的这一点上，框架开发与业务逻辑开发是很接近的，这样目标驱动的开发模式也有利于保持开发流程的可控，而非像实现简单业务需求那样随心所欲地【想到什么写什么】，以至于最后产出缺乏架构支持而不易维护的代码。</p>
<p>那么，NanoMVC 框架的使用情景是什么呢？常见的后端框架所封装的功能，不外乎对数据的增查改删与渲染。在前端，我们以一个非常简单的 Todo App 作为框架所需要支持的业务开发场景，这时基于框架的业务代码，所需要实现的功能包括：</p>
<ul>
<li><strong>TodoModel</strong> 模块实现 Todo 这一数据模型的存取。</li>
<li><strong>TodoView</strong> 模块实现将 Todo 数据模型渲染到页面。</li>
<li><strong>TodoController</strong> 模块实现对 Todo 数据的新增、编辑、删除等操作。</li>
</ul>
<p>在用于实现 Todo 业务逻辑的 Model 和 Controller 模块，除了具备框架提供的若干功能外，还需要在其中编写特定的业务代码。这时，面向对象的编程范式就能够发挥作用了：通过形如 TodoController 的业务代码【继承】框架所提供的 Controller 基类，在其中即可调用框架所封装的功能。这也就意味着，该框架的功能是需要支持通过继承来使用的。</p>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><p>在【支持 MVC 三个模块】与【支持通过继承使用】的两个目标确定后，即可以框架使用者的身份，给出调用框架的基础示例代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/index.js</span></span><br><span class="line"><span class="comment">// Todo App 的业务代码入口</span></span><br><span class="line"><span class="comment">// 该示例为实际业务代码，并非框架代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 依次导入 MVC 的三个模块</span></span><br><span class="line"><span class="keyword">import</span> &#123; TodoModel &#125; <span class="keyword">from</span> <span class="string">'./model'</span></span><br><span class="line"><span class="keyword">import</span> &#123; TodoController &#125; <span class="keyword">from</span> <span class="string">'./controller'</span></span><br><span class="line"><span class="keyword">import</span> &#123; TodoView <span class="keyword">as</span> view &#125; <span class="keyword">from</span> <span class="string">'./view'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例化各模块</span></span><br><span class="line"><span class="comment">// 此处 View 的实现由于过于简单而不需实例化</span></span><br><span class="line"><span class="keyword">const</span> model = <span class="keyword">new</span> TodoModel()</span><br><span class="line"><span class="keyword">const</span> controller = <span class="keyword">new</span> TodoController(model, view)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过手动调用 render 方法，初始化页面</span></span><br><span class="line"><span class="comment">// 在 controller 中 render 值得商榷</span></span><br><span class="line"><span class="comment">// 但其不失为一种很方便的实现</span></span><br><span class="line">controller.render()</span><br></pre></td></tr></table></figure>
<p>在这个应用的入口模块中，仅仅明确了 MVC 模块拆分的基本结构，而并没有给出各业务模块的基本实现示例。下面给出以框架使用者的角度，在利用框架实现 TodoModel 模块时的基本示例代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// model.js</span></span><br><span class="line"><span class="comment">// 该示例为实际业务代码，并非框架代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从框架中导入 Model 基类</span></span><br><span class="line"><span class="keyword">import</span> &#123; Model &#125; <span class="keyword">from</span> <span class="string">'framework'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过继承实现自己的业务 Model</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">TodoModel</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 在构造器中定义数据模型的基本结构</span></span><br><span class="line">  <span class="comment">// 在此即为 Todo 列表</span></span><br><span class="line">  <span class="keyword">constructor</span> () &#123;</span><br><span class="line">    <span class="keyword">super</span>(&#123; <span class="attr">todos</span>: [] &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 利用 ES6 class 语法定义模型实例的 getter</span></span><br><span class="line">  <span class="comment">// 从而在调用 model.todos 时返回正确的 Todo 数据</span></span><br><span class="line">  <span class="keyword">get</span> todos () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.data.todos</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 利用 ES6 class 语法定义模型实例的 setter</span></span><br><span class="line">  <span class="comment">// 从而在执行形如 modle.todos = newTodos 的赋值时</span></span><br><span class="line">  <span class="comment">// 能够通知订阅了 Model 的模块进行相应更新</span></span><br><span class="line">  <span class="keyword">set</span> todos (todos) &#123;</span><br><span class="line">    <span class="keyword">this</span>.data.todos = todos</span><br><span class="line">    <span class="keyword">this</span>.publish(todos)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>虽然 Model 模块的有效代码仅有十余行，但其实现中已体现了使用框架的基本方式：</p>
<ol>
<li>导入框架提供的基类。</li>
<li>继承基类，根据实际业务需求定制出相应的模块实例。</li>
</ol>
<p>与之类似地，实现 TodoController 模块的业务代码，也按照类似的思路进行组织：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// controller.js</span></span><br><span class="line"><span class="comment">// 该示例为实际业务代码，并非框架代码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Controller &#125; <span class="keyword">from</span> <span class="string">'framework'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 同样基于继承实现业务特定的 Controller</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">TodoController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> (model, view) &#123;</span><br><span class="line">    <span class="comment">// 在此提供实例化 Controller 时所需的参数</span></span><br><span class="line">    <span class="comment">// 包括其对应的 Model 与 View，及相应的业务逻辑功能</span></span><br><span class="line">    <span class="keyword">super</span>(&#123;</span><br><span class="line">      model,</span><br><span class="line">      view,</span><br><span class="line">      el: <span class="string">'#app'</span>,</span><br><span class="line">      <span class="comment">// 提供点击页面特定按钮时的处理逻辑</span></span><br><span class="line">      onClick: &#123;</span><br><span class="line">        <span class="comment">// 点击【新增】按钮时，新增 Todo</span></span><br><span class="line">        <span class="string">'.btn-add'</span> () &#123;</span><br><span class="line">          <span class="comment">// this.model.todos = ...</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 点击【删除】按钮时，删除相应的 Todo</span></span><br><span class="line">        <span class="string">'.btn-delete'</span> (e) &#123;</span><br><span class="line">          <span class="comment">// this.model.todos = ...</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 点击【更新】按钮时，更新相应的 Todo</span></span><br><span class="line">        <span class="string">'.btn-update'</span> (e) &#123;</span><br><span class="line">          <span class="comment">// 根据 id 更新元素</span></span><br><span class="line">          <span class="comment">// this.model.todos = ...</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 订阅 Model 更新事件</span></span><br><span class="line">    <span class="comment">// 在 Model 更新时执行 controller 的 render 方法</span></span><br><span class="line">    <span class="keyword">this</span>.model.subscribers.push(<span class="keyword">this</span>.render)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在实现了这个 Controller 后，基本的业务逻辑流程已经初见端倪了：</p>
<ol>
<li>Controller 根据 onClick 参数中提供的字段，<strong>声明式地</strong>定义形如【当 class 名称包含 <code>btn-add</code> 的按钮点击时】所触发的业务逻辑，从而避免 <code>$(...)</code> 绑定点击事件的底层操作。</li>
<li>在点击事件触发时，<strong>不去直接修改 DOM</strong>，而是更新 <code>this.model</code> 中的数据。这样，就实现了数据模型与页面视图的分离解耦。</li>
<li>还记得 <code>model.js</code> 中实现的 <code>this.publish(todos)</code> 吗？在上一步中数据更新触发数据模型的 setter 时，Model 将通知【数据变更】的事件至模型的所有订阅者。</li>
<li>在 Controller 的最后一行有效代码中，它订阅了数据模型的更新事件。故而在数据更新时，将触发 render 方法以重绘 DOM。</li>
</ol>
<p>在这个流程中，不仅包含了对业务逻辑相关事件的配置式 / 声明式定义，还实现了发布 - 订阅这一设计模式，该模式也广泛应用在 MVC 框架设计中。而在 Controller 中业务逻辑成功更新后，最后需要的就是更新 View 了。相应的 TodoView 模块示例如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// view.js</span></span><br><span class="line"><span class="comment">// 该模块是一个【输入数据，输出 HTML 模板】的纯函数</span></span><br><span class="line"><span class="comment">// 故而在业务代码中即可实现其全部功能，不需要继承</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">TodoView</span> (<span class="params">&#123; todos &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 根据 Todo 数组数据</span></span><br><span class="line">  <span class="comment">// 通过 map 得到带【编辑】与【删除】按钮的单条 Todo 页面模板</span></span><br><span class="line">  <span class="keyword">const</span> todosList = todos.map(<span class="function"><span class="params">todo</span> =&gt;</span> <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;span&gt;<span class="subst">$&#123;todo.text&#125;</span>&lt;/span&gt;</span></span><br><span class="line"><span class="string">      &lt;button data-id="<span class="subst">$&#123;todo.id&#125;</span>" class="btn-delete"&gt;</span></span><br><span class="line"><span class="string">        Delete</span></span><br><span class="line"><span class="string">      &lt;/button&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      &lt;span&gt;</span></span><br><span class="line"><span class="string">        &lt;input data-id="<span class="subst">$&#123;todo.id&#125;</span>"/&gt;</span></span><br><span class="line"><span class="string">        &lt;button data-id="<span class="subst">$&#123;todo.id&#125;</span>" class="btn-update"&gt;</span></span><br><span class="line"><span class="string">          Update</span></span><br><span class="line"><span class="string">        &lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;/span&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>).join(<span class="string">''</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 通过 ES6 模板字符串实现类似 JSX 格式的 View 输出</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="string">`</span></span><br><span class="line"><span class="string">    &lt;main&gt;</span></span><br><span class="line"><span class="string">      &lt;input class="input-add"/&gt;</span></span><br><span class="line"><span class="string">      &lt;button class="btn-add"&gt;Add&lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;div&gt;<span class="subst">$&#123;todosList&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/main&gt;</span></span><br><span class="line"><span class="string">  `</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到此为止，我们已经勾画出业务代码的全貌了。接下来需要的就是实现 NanoMVC 这一框架，从而让这些代码能够在框架的支持下正常运行。</p>
<h2 id="编码实现"><a href="#编码实现" class="headerlink" title="编码实现"></a>编码实现</h2><p>在给定了设计目标以及示例功能后，框架的开发并没有想象中复杂。根据上文中编写示例代码时的梳理，我们的 NanoMVC 框架中需实现的功能包括：</p>
<ul>
<li>Model 基类中实现对模型数据的发布 - 订阅设计模式。</li>
<li>Controller 基类中实现：<ul>
<li>与 Model / View 实例的绑定。</li>
<li>对点击事件、DOM 选择等底层 API 的封装。</li>
<li>用于渲染数据的 Render 方法。</li>
</ul>
</li>
</ul>
<h3 id="Model-模块"><a href="#Model-模块" class="headerlink" title="Model 模块"></a>Model 模块</h3><p>由于 Model 中功能最为简单，且其为 Controller 实例的依赖，故而我们首先实现其中的发布 - 订阅模式：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// framework/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对外暴露的 Model 基类</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 在构造器中实例化数据与订阅者</span></span><br><span class="line">  <span class="keyword">constructor</span> (data) &#123;</span><br><span class="line">    <span class="keyword">this</span>.data = data</span><br><span class="line">    <span class="keyword">this</span>.subscribers = []</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 由 TodoModel 实例调用的发布方法</span></span><br><span class="line">  <span class="comment">// 在 TodoModel 中的 setter 更新时，将新数据传入该方法</span></span><br><span class="line">  <span class="comment">// 由该方法将新数据推送到每个订阅者提供的回调中</span></span><br><span class="line">  <span class="comment">// 在 Todo 项目中，订阅者为 TodoController 的 render 方法</span></span><br><span class="line">  publish (data) &#123;</span><br><span class="line">    <span class="keyword">this</span>.subscribers.forEach(<span class="function"><span class="params">callback</span> =&gt;</span> callback(data))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在示例中可以发现，所谓的发布 - 订阅模式，其思路和实现均非常简单：</p>
<ol>
<li>区分出【发布者】和【订阅者】的概念。本例中 Model 为发布者，Controller 为订阅者。</li>
<li>在发布者中维护【我有哪些订阅者】信息的数组，每个元素为一个订阅者提供的回调。</li>
<li>发布者数据更新时，依次触发所有订阅者的回调。</li>
</ol>
<p>不过，Model 中的代码仅实现了【初始化发布者】与【触发所有订阅】的功能，并不是一个完整的发布 - 订阅模式。在完整的模式实现中，其余代码包括：</p>
<ol>
<li>【订阅者订阅发布者】机制的实现，其代码位置为 <code>controller.js</code> 中的最后一行 <code>this.model.subscribers.push(this.render)</code>，在此将 render 方法作为订阅者回调，提供给了发布者。</li>
<li>【数据更新时，触发订阅回调】机制的实现，其代码位置为 <code>model.js</code> 中 <code>set todos (todos)</code> 内的一行 <code>this.publish(todos)</code>。在此，通过 ES6 中 Class 语法的 setter 机制，在模型数据更新时，调用 Model 基类提供的 publish 方法，触发订阅。</li>
<li>【订阅者提供的订阅方法】的实现，在此即为 TodoController 中提供的 <code>this.render</code> 方法。该方法并未在 TodoController 的业务代码中实现，而是在接下来的框架 Controller 基类中实现的。 </li>
</ol>
<h3 id="Controller-模块"><a href="#Controller-模块" class="headerlink" title="Controller 模块"></a>Controller 模块</h3><p>上文中已经明确，框架提供的 Controller 基类需要实现的功能为：</p>
<ul>
<li>与 Model / View 实例的绑定。</li>
<li>对点击事件、DOM 选择等底层 API 的封装。</li>
<li>用于渲染数据的 Render 方法。</li>
</ul>
<p>以下是相应的实现，去除注释后仅在 20 行的数量级：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// framework/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对外暴露的 Controller 基类</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> (conf) &#123;</span><br><span class="line">    <span class="comment">// 根据子类提供的实例化参数，定义 Controller 基础配置</span></span><br><span class="line">    <span class="comment">// 包括 DOM 容器、Model / View 实例及 onClick 事件等</span></span><br><span class="line">    <span class="keyword">this</span>.el = <span class="built_in">document</span>.querySelector(conf.el)</span><br><span class="line">    <span class="keyword">this</span>.model = conf.model</span><br><span class="line">    <span class="keyword">this</span>.view = conf.view</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 常见于 React 开发中的 bind</span></span><br><span class="line">    <span class="comment">// 解决方法在 extend 出的实例中执行时的 this 指向问题</span></span><br><span class="line">    <span class="keyword">this</span>.render = <span class="keyword">this</span>.render.bind(<span class="keyword">this</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据 TodoController 中提供的 onClick 配置规则执行业务逻辑</span></span><br><span class="line">    <span class="comment">// 例如 TodoController 若在 onClick 属性中提供了名为 .btn-add 的函数</span></span><br><span class="line">    <span class="comment">// 则在 Controller 对应 DOM 中点击事件触发时</span></span><br><span class="line">    <span class="comment">// 事件 path 的根元素若带有匹配 btn-add 的 className</span></span><br><span class="line">    <span class="comment">// 即执行 TodoController 提供的 .btn-add 函数</span></span><br><span class="line">    <span class="keyword">this</span>.el.addEventListener(<span class="string">'click'</span>, (e) =&gt; &#123;</span><br><span class="line">      e.stopPropagation()</span><br><span class="line">      <span class="keyword">const</span> rules = <span class="built_in">Object</span>.keys(conf.onClick || &#123;&#125;)</span><br><span class="line">      rules.forEach(<span class="function">(<span class="params">rule</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 匹配事件根元素，并据此执行业务 Controller 实例提供的业务逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (e.path[<span class="number">0</span>].matches(rule)) conf.onClick[rule].call(<span class="keyword">this</span>, e)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 供业务 Controller 实例使用的 API 方法</span></span><br><span class="line">  <span class="comment">// 从而避免在业务代码中直接操作 DOM</span></span><br><span class="line">  <span class="comment">// 首先是事件对象，返回事件根元素的特定属性</span></span><br><span class="line">  getTargetAttr (e, attr) &#123;</span><br><span class="line">    <span class="keyword">return</span> e.path[<span class="number">0</span>].getAttribute(attr)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 同样供业务 Controller 实例使用的 API 方法</span></span><br><span class="line">  <span class="comment">// 提供在 Controller 对应 DOM 内查找元素的 API</span></span><br><span class="line">  getChild (selector) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.el.querySelector(selector)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 全量重置 DOM 的 naive render 实现</span></span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="comment">// 由于 view 是纯函数，故而直接对其传入 Model 数据</span></span><br><span class="line">    <span class="comment">// 将输出的 HTML 模板作为 Controller DOM 内的新状态</span></span><br><span class="line">    <span class="keyword">this</span>.el.innerHTML = <span class="keyword">this</span>.view(<span class="keyword">this</span>.model)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基于这个 Controller 基类的实现，可以完善出前文中 TodoController 剩余的若干业务代码如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// controller.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">      onClick: &#123;</span><br><span class="line">        <span class="string">'.btn-add'</span> () &#123;</span><br><span class="line">          <span class="comment">// 新增 Todo 时操作</span></span><br><span class="line">          <span class="comment">// 由于简单的 setter 监测不到 push 方法的改动</span></span><br><span class="line">          <span class="comment">// 故而对 Todos 数据全量赋值</span></span><br><span class="line">          <span class="keyword">this</span>.model.todos = <span class="keyword">this</span>.model.todos.concat([&#123;</span><br><span class="line">            id: <span class="keyword">new</span> <span class="built_in">Date</span>().getTime().toString(),</span><br><span class="line">            <span class="comment">// 使用 getter 获取【添加 Todo】输入框中的数据</span></span><br><span class="line">            text: <span class="keyword">this</span>.addInputText</span><br><span class="line">          &#125;])</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 根据 id 过滤掉待删除元素</span></span><br><span class="line">        <span class="string">'.btn-delete'</span> (e) &#123;</span><br><span class="line">          <span class="keyword">const</span> id = <span class="keyword">this</span>.getTargetAttr(e, <span class="string">'data-id'</span>)</span><br><span class="line">          <span class="keyword">this</span>.model.todos = <span class="keyword">this</span>.model.todos.filter(</span><br><span class="line">            todo =&gt; todo.id !== id</span><br><span class="line">          )</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 根据 id 查找出待更新 Todo 文本并更新</span></span><br><span class="line">        <span class="string">'.btn-update'</span> (e) &#123;</span><br><span class="line">          <span class="keyword">const</span> id = <span class="keyword">this</span>.getTargetAttr(e, <span class="string">'data-id'</span>)</span><br><span class="line">          <span class="keyword">const</span> text = <span class="keyword">this</span>.getUpdateText(id)</span><br><span class="line">          <span class="comment">// 通过 map 全量对新 Todos 列表赋值</span></span><br><span class="line">          <span class="keyword">this</span>.model.todos = <span class="keyword">this</span>.model.todos.map(</span><br><span class="line">            todo =&gt; (&#123;</span><br><span class="line">              id: todo.id,</span><br><span class="line">              text: todo.id === id ? text : todo.text</span><br><span class="line">            &#125;)</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>新增的 TodoController 实例方法如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 调用框架 API，根据当前编辑 Todo 的 ID，获取其文本</span></span><br><span class="line">getUpdateText (id) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">super</span>.getChild(<span class="string">`input[data-id="<span class="subst">$&#123;id&#125;</span>"]`</span>).value</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取【添加 Todo】输入框中的数据</span></span><br><span class="line"><span class="keyword">get</span> addInputText () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">super</span>.getChild(<span class="string">'.input-add'</span>).value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后实现的业务代码中，只需在名为形如 <code>.btn-add</code> 的函数中调用框架封装好的方法，就能实现对 DOM 的查找及对数据的增查改删，不再需要显式地查找与修改 DOM 了。</p>
<h3 id="View-模块"><a href="#View-模块" class="headerlink" title="View 模块"></a>View 模块</h3><p>如前文所述，框架的 View 实质上就是一个在 Model 中数据变更时，由 Controller 在 render 方法中执行的一个纯函数。由于 View 过于简单，故而在框架代码的实现中，没有涉及 View 这一模块。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在实现 MVC 模式框架的过程中，框架的【模块拆分】与【功能封装】特性均得到了体现，而 ES6 所提供的 class 高级特性则大大简化这些特性的实现复杂度。例如，如果没有 setter 语法糖，那么实现发布 - 订阅模式中最关键的【在数据更新时执行代码】特性时，要么需要额外封装出框架的 get 和 set API，要么需要采用 <code>Object.defineProperty</code> 这样较为 Hack 的手段。</p>
<p>有趣的一点是，从实现框架过程中提供的示例代码来看，框架代码虽少，但其注释量显著多于业务代码。在许多成熟的开源项目中，注释所占比重也相当大。造成这种情况的原因，除了框架层开发者的编码习惯较好外，还有一个潜在的原因：框架开发中，提供的代码多是【供用户调用】的 API 代码，在没有用户提供代码的情况下，整个框架的执行流程可能是无法走通的（例如整个发布 - 订阅模式的实现代码，就分散在了各个模块中）。这时，对于许多<strong>执行流程不连续且缺乏调用者信息的代码片段</strong>，就需要提供传统的参数类型信息外，更丰富的【代码调用场景、作用场景、Hack 理由】等信息，来保证框架代码的可维护性。从这个角度上来说，框架级的开发也有助于培养开发者的编码习惯。</p>
<p>当然，这个框架毕竟只是一个简单 Demo，与真实世界中的框架相比，还存在许多问题：</p>
<ul>
<li>不支持父子组件嵌套的机制。</li>
<li>基于 innerHTML 的渲染性能低下。</li>
<li>Controller 与 View 是一对一的关系，且直接将 Model 传入 View 函数来获取模板，不够灵活。</li>
<li>不支持为特定元素单独设置事件监听器，只能拦截所有事件到 Controller DOM 顶层处理。</li>
<li>只支持通过对 Model 的全量赋值来触发发布 - 订阅机制，使得 TodoController 中的增查改删业务代码虽然剥离的 DOM，但仍然较为臃肿。</li>
</ul>
<p>这些存在的问题，正是后续文章中所介绍的新类库 / 框架所要解决的。NanoMVC 正是引出对更高级的框架机制介绍的一个引子。</p>
<p>本文<a href="https://github.com/doodlewind/nano-mvc" target="_blank" rel="noopener">示例地址</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Note/">Note</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/JS/">JS</a><a href="/tags/Pattern/">Pattern</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://ewind.us/2017/nano-mvc/" data-title="自制前端框架之 MVC | ewind the doodler" data-tsina="undefined" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2017/nano-vdom/" title="自制前端框架之 50 行的虚拟 DOM">
  <strong>上一篇：</strong><br/>
  <span>
  自制前端框架之 50 行的虚拟 DOM</span>
</a>
</div>


<div class="next">
<a href="/2017/hackathon-memo/"  title="Hackathon 参赛总结">
 <strong>下一篇：</strong><br/> 
 <span>Hackathon 参赛总结
</span>
</a>
</div>

</nav>

	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介与动机"><span class="toc-number">1.</span> <span class="toc-text">简介与动机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#框架特性"><span class="toc-number">2.</span> <span class="toc-text">框架特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用示例"><span class="toc-number">3.</span> <span class="toc-text">使用示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编码实现"><span class="toc-number">4.</span> <span class="toc-text">编码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Model-模块"><span class="toc-number">4.1.</span> <span class="toc-text">Model 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Controller-模块"><span class="toc-number">4.2.</span> <span class="toc-text">Controller 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#View-模块"><span class="toc-number">4.3.</span> <span class="toc-text">View 模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="doodlewind" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript">
(function(e){var t="//cdn.jsdelivr.net/github-cards/1.0.2/";var r,i=0;var a=e.getElementsByTagName("meta");var n,d,l,c;for(r=0;r<a.length;r++){var s=a[r].getAttribute("name");var f=a[r].getAttribute("content");if(s==="gc:url"){n=f}else if(s==="gc:base"){t=f}else if(s==="gc:client-id"){d=f}else if(s==="gc:client-secret"){l=f}else if(s==="gc:theme"){c=f}}function u(t){if(e.querySelectorAll){return e.querySelectorAll("."+t)}var i=e.getElementsByTagName("div");var a=[];for(r=0;r<i.length;r++){if(~i[r].className.split(" ").indexOf(t)){a.push(i[r])}}return a}function g(e,t){return e.getAttribute("data-"+t)}function h(e){if(window.addEventListener){window.addEventListener("message",function(t){if(e.id===t.data.sender){e.height=t.data.height}},false)}}function v(r,a){a=a||n;if(!a){var s=g(r,"theme")||c||"default";a=t+"cards/"+s+".html"}var f=g(r,"user");var u=g(r,"repo");var v=g(r,"github");if(v){v=v.split("/");if(v.length&&!f){f=v[0];u=u||v[1]}}if(!f){return}i+=1;var o=g(r,"width");var m=g(r,"height");var b=g(r,"target");var w=g(r,"client-id")||d;var p=g(r,"client-secret")||l;var A="ghcard-"+f+"-"+i;var y=e.createElement("iframe");y.setAttribute("style","width:100%");y.setAttribute("id",A);y.setAttribute("frameborder",0);y.setAttribute("scrolling",0);y.setAttribute("allowtransparency",true);var E=a+"?user="+f+"&identity="+A;if(u){E+="&repo="+u}if(b){E+="&target="+b}if(w&&p){E+="&client_id="+w+"&client_secret="+p}y.src=E;y.width=o||Math.min(r.parentNode.clientWidth||400,400);if(m){y.height=m}h(y);r.parentNode.replaceChild(y,r);return y}var o=u("github-card");for(r=0;r<o.length;r++){v(o[r])}if(window.githubCard){window.githubCard.render=v}})(document);
</script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Note/" title="Note">Note<sup>143</sup></a></li>
		  
		
		  
			<li><a href="/categories/Scribble/" title="Scribble">Scribble<sup>26</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Web/" title="Web">Web<sup>73</sup></a></li>
			
		
			
				<li><a href="/tags/JS/" title="JS">JS<sup>54</sup></a></li>
			
		
			
				<li><a href="/tags/Summary/" title="Summary">Summary<sup>28</sup></a></li>
			
		
			
				<li><a href="/tags/Algorithms/" title="Algorithms">Algorithms<sup>19</sup></a></li>
			
		
			
				<li><a href="/tags/USTC/" title="USTC">USTC<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/macOS/" title="macOS">macOS<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/Photography/" title="Photography">Photography<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/Pattern/" title="Pattern">Pattern<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/CSS/" title="CSS">CSS<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Assembly/" title="Assembly">Assembly<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Visualization/" title="Visualization">Visualization<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Android/" title="Android">Android<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Vue/" title="Vue">Vue<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Blog/" title="Blog">Blog<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/React/" title="React">React<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/SQL/" title="SQL">SQL<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Travel/" title="Travel">Travel<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/JavaScript/" title="JavaScript">JavaScript<sup>2</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://ustc.life" target="_blank" title=" 科大学生导航主页">ustc.life</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.unichow.com" target="_blank" title=" hengyu">Art</a>
            
          </li>
        
          <li>
            
            	<a href="https://ring0.me" target="_blank" title=" boj">Ring0</a>
            
          </li>
        
          <li>
            
            	<a href="https://sqrt-1.me" target="_blank" title=" zzh">负一的平方根</a>
            
          </li>
        
          <li>
            
            	<a href="http://0x01.me" target="_blank" title=" wzb">机智的超立方体</a>
            
          </li>
        
          <li>
            
            	<a href="https://jenny42.com" target="_blank" title=" jenny42">Jenny&#39;s Life</a>
            
          </li>
        
          <li>
            
            	<a href="http://sadhen.com" target="_blank" title=" sadhen">Sadhen</a>
            
          </li>
        
          <li>
            
            	<a href="http://chenyuelili.com/" target="_blank" title=" chenyueli">快乐小小利</a>
            
          </li>
        
          <li>
            
            	<a href="https://richardcao.me/" target="_blank" title=" richardcao">Lifecycle</a>
            
          </li>
        
          <li>
            
            	<a href="https://wangbaiyuan.cn/" target="_blank" title=" BrainWang">王柏元的博客</a>
            
          </li>
        
    </ul>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/doodlewind" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		<a href="http://www.zhihu.com/people/doodlewind" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
	</div>
			
		
				<div class="cc-license">
          <a href="http://creativecommons.org/licenses/by-nd/4.0" class="cc-opacity" target="_blank">
            <img src="/img/cc-by-nd.svg" alt="Creative Commons" />
          </a>
        </div>
    

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a>
		Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a>
		Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>
		© 2020 
		
		<a href="/about" target="_blank" title="doodlewind">doodlewind</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan hidden id='cnzz_stat_icon_1260460098'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s23.cnzz.com/z_stat.php%3Fid%3D1260460098' type='text/javascript'%3E%3C/script%3E"));</script>

<!-- Analytics End -->

<!-- Totop Begin -->

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
